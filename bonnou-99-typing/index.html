<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>99の煩悩タイピング浄化道場 - 99th Meaningless App Special</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Mincho ProN', 'Yu Mincho', serif;
            background: linear-gradient(135deg, #1a0a2e 0%, #0f0518 50%, #2a1a3a 100%);
            overflow: hidden;
            color: #fff;
        }

        #mainCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        #effectCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3;
            pointer-events: none;
        }

        .ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 4;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 40px;
        }

        .header {
            text-align: center;
            animation: glow 3s ease-in-out infinite;
        }

        .title {
            font-size: 48px;
            font-weight: bold;
            text-shadow: 0 0 20px #ff6b9d, 0 0 40px #c44569, 0 0 60px #944e63;
            margin-bottom: 10px;
            letter-spacing: 8px;
        }

        .subtitle {
            font-size: 24px;
            color: #ffd93d;
            text-shadow: 0 0 10px #ffd93d;
            letter-spacing: 4px;
        }

        .special-badge {
            font-size: 36px;
            color: #ff6b9d;
            text-shadow: 0 0 20px #ff6b9d;
            margin-top: 10px;
            animation: pulse 2s ease-in-out infinite;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-height: 70vh;
            overflow: visible;
        }

        .counter-display {
            font-size: 100px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 30px #6c5ce7, 0 0 60px #a29bfe, 0 0 90px #74b9ff;
            animation: float 3s ease-in-out infinite;
        }

        .bonnou-display {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px 40px;
            border-radius: 20px;
            border: 3px solid #ffd93d;
            box-shadow: 0 0 40px rgba(255, 217, 61, 0.5);
            min-width: 600px;
            text-align: center;
        }

        .bonnou-name {
            font-size: 36px;
            color: #ffd93d;
            margin-bottom: 10px;
            text-shadow: 0 0 20px #ffd93d;
        }

        .bonnou-description {
            font-size: 18px;
            color: #ddd;
            line-height: 1.5;
        }

        .typing-area {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px 30px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            min-width: 700px;
            max-width: 700px;
            min-height: 80px;
            max-height: 150px;
            font-size: 48px;
            text-align: center;
            letter-spacing: 8px;
            line-height: 1.4;
            box-shadow: 0 0 30px rgba(108, 92, 231, 0.3);
            overflow: hidden;
            word-wrap: break-word;
        }

        .progress-container {
            width: 80%;
            max-width: 800px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .progress-bar {
            width: 100%;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid #6c5ce7;
            box-shadow: 0 0 20px rgba(108, 92, 231, 0.5);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b9d, #ffd93d, #6c5ce7, #00b894);
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
            transition: width 0.5s ease-out;
            box-shadow: 0 0 20px rgba(255, 107, 157, 0.8);
        }

        .stats {
            display: flex;
            gap: 40px;
            justify-content: center;
        }

        .stat-item {
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px 40px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .stat-label {
            font-size: 16px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #ffd93d;
            text-shadow: 0 0 10px #ffd93d;
        }

        .zen-quote {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #fff;
            text-align: center;
            text-shadow: 0 0 40px #6c5ce7;
            opacity: 0;
            pointer-events: none;
            z-index: 10;
            max-width: 80%;
            line-height: 1.8;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px #ff6b9d, 0 0 40px #c44569; }
            50% { text-shadow: 0 0 40px #ff6b9d, 0 0 80px #c44569, 0 0 120px #ff6b9d; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 200px;
            opacity: 0;
            pointer-events: none;
            z-index: 11;
            animation: celebrate 2s ease-out;
        }

        @keyframes celebrate {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.5); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        }

        .instruction {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            z-index: 5;
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .enlightenment-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.95), rgba(255, 215, 0, 0.9));
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: enlighten 3s ease-out;
        }

        @keyframes enlighten {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 1; }
        }

        .enlightenment-text {
            font-size: 72px;
            color: #6c5ce7;
            text-shadow: 0 0 50px rgba(108, 92, 231, 0.8);
            margin-bottom: 30px;
            animation: enlightenPulse 2s ease-in-out infinite;
        }

        @keyframes enlightenPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .enlightenment-message {
            font-size: 36px;
            color: #333;
            text-align: center;
            max-width: 800px;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <canvas id="mainCanvas"></canvas>
    <canvas id="particleCanvas"></canvas>
    <canvas id="effectCanvas"></canvas>

    <div class="ui-container">
        <div class="header">
            <div class="title">九十九の煩悩浄化道場</div>
            <div class="subtitle">BONNOU PURIFICATION DOJO</div>
            <div class="special-badge">★ 99th SPECIAL EDITION ★</div>
        </div>

        <div class="main-content">
            <div class="counter-display" id="counter">0</div>

            <div class="bonnou-display">
                <div class="bonnou-name" id="bonnouName">煩悩を浄化中...</div>
                <div class="bonnou-description" id="bonnouDesc">キーボードを打って心を無に...</div>
            </div>

            <div class="typing-area" id="typingArea">無</div>

            <div class="progress-container">
                <div class="progress-label">
                    <span>浄化進度</span>
                    <span id="progressText">0/99</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">総打鍵数</div>
                <div class="stat-value" id="totalKeys">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">浄化済煩悩</div>
                <div class="stat-value" id="purifiedCount">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">悟りレベル</div>
                <div class="stat-value" id="enlightenmentLevel">0</div>
            </div>
        </div>
    </div>

    <div class="zen-quote" id="zenQuote"></div>
    <div class="instruction">キーボードの任意のキーを打って煩悩を浄化しましょう（何を打っても全て「無」になります）</div>

    <div class="enlightenment-screen" id="enlightenmentScreen">
        <div class="enlightenment-text">✨ ほぼ悟りの境地 ✨</div>
        <div class="enlightenment-message">
            99の煩悩を浄化されました<br>
            （残り9つは次の機会に...）<br><br>
            おめでとうございます！
        </div>
    </div>

    <script>
        // ========================================
        // AI Model: Claude 3.5 Sonnet
        // User Prompt: 99回目の作品として、99という数字に意味を持たせた派手な演出のタイピングアプリ
        // AI Approach: Multi-layer Canvas system, Web Audio API, particle effects, 99 bonnou database
        // Implementation Intent: 99th special edition - maximum visual effects and meaningless but entertaining experience
        // ========================================

        // 99個の煩悩データベース
        const BONNOU_LIST = [
            { name: "承認欲求", desc: "SNSのいいねが気になる心" },
            { name: "二度寝", desc: "アラームを止めてしまう弱き心" },
            { name: "スマホ依存", desc: "常に画面を見てしまう執着" },
            { name: "先延ばし", desc: "明日やろうは馬鹿野郎" },
            { name: "食べ過ぎ", desc: "お腹いっぱいでももう一口" },
            { name: "夜更かし", desc: "寝る前のYouTubeが止まらない" },
            { name: "衝動買い", desc: "ポチッとしてしまう指" },
            { name: "比較癖", desc: "他人と自分を比べる心" },
            { name: "完璧主義", desc: "100点以外は許せない心" },
            { name: "心配性", desc: "起きてもいないことを心配する" },
            { name: "怠惰", desc: "今日くらいサボってもいいか精神" },
            { name: "嫉妬", desc: "他人の幸せが羨ましい" },
            { name: "見栄", desc: "良く見られたい気持ち" },
            { name: "プライド", desc: "負けを認められない心" },
            { name: "愚痴", desc: "文句を言わずにいられない" },
            { name: "八つ当たり", desc: "関係ない人に当たる弱さ" },
            { name: "執着", desc: "手放せない物や思い出" },
            { name: "後悔", desc: "過去に囚われる心" },
            { name: "不安", desc: "未来が怖い気持ち" },
            { name: "焦り", desc: "急がなくてもいいのに急ぐ心" },
            { name: "怒り", desc: "イライラが止まらない" },
            { name: "恨み", desc: "許せない気持ち" },
            { name: "復讐心", desc: "やり返したい衝動" },
            { name: "傲慢", desc: "自分が一番だと思う心" },
            { name: "無知の自覚なし", desc: "知らないことを知らない" },
            { name: "依存", desc: "何かに頼らずにいられない" },
            { name: "逃避", desc: "現実から目を背ける" },
            { name: "妄想", desc: "起きてもいないことを考える" },
            { name: "優柔不断", desc: "決められない心の弱さ" },
            { name: "八方美人", desc: "みんなに好かれたい欲" },
            { name: "自己否定", desc: "自分を責めてしまう癖" },
            { name: "自己中心", desc: "自分のことしか考えない" },
            { name: "被害妄想", desc: "悪く取りすぎる思考" },
            { name: "ネガティブ思考", desc: "悪い方にばかり考える" },
            { name: "取り越し苦労", desc: "心配しすぎる性格" },
            { name: "ケチ", desc: "出すべき時にも出せない" },
            { name: "浪費", desc: "使いすぎてしまう癖" },
            { name: "見返り期待", desc: "何かを期待して動く心" },
            { name: "独占欲", desc: "自分だけのものにしたい" },
            { name: "支配欲", desc: "コントロールしたい欲求" },
            { name: "名誉欲", desc: "有名になりたい気持ち" },
            { name: "権力欲", desc: "力を持ちたい欲望" },
            { name: "知識欲の暴走", desc: "知りすぎて行動できない" },
            { name: "完璧主義の押し付け", desc: "他人にも完璧を求める" },
            { name: "正義感の暴走", desc: "自分の正義を押し付ける" },
            { name: "説教癖", desc: "人に教えたがる性質" },
            { name: "マウント", desc: "上に立ちたい欲求" },
            { name: "噂好き", desc: "ゴシップが気になる心" },
            { name: "詮索", desc: "人のことを知りたがる" },
            { name: "盗み見", desc: "見てはいけないものを見る" },
            { name: "盗み聞き", desc: "聞いてはいけない話を聞く" },
            { name: "ドタキャン常習", desc: "約束を守れない弱さ" },
            { name: "遅刻癖", desc: "時間を守れない甘え" },
            { name: "言い訳", desc: "自分を正当化する癖" },
            { name: "責任転嫁", desc: "人のせいにする卑怯さ" },
            { name: "現実逃避ゲーム", desc: "やるべきことをせずゲーム" },
            { name: "ドラマ見過ぎ", desc: "次の話が気になって寝不足" },
            { name: "漫画読破欲", desc: "徹夜で全巻読む衝動" },
            { name: "SNS巡回", desc: "タイムラインを見続ける" },
            { name: "通知確認癖", desc: "来てもいない通知をチェック" },
            { name: "既読スルー恐怖", desc: "すぐ返信しなきゃ不安" },
            { name: "未読無視罪悪感", desc: "読まないと気になる" },
            { name: "フォロワー数執着", desc: "数字ばかり気にする" },
            { name: "バズりたい欲", desc: "バイラルを夢見る心" },
            { name: "リア充アピール", desc: "充実してると見せたい" },
            { name: "写真盛りすぎ", desc: "加工しすぎる自分" },
            { name: "自撮り過多", desc: "何枚も撮り直す執着" },
            { name: "エアリプ", desc: "直接言えない臆病さ" },
            { name: "サブ垢", desc: "本音を別垢で言う二面性" },
            { name: "炎上ウォッチ", desc: "他人の不幸を見てしまう" },
            { name: "ネットサーフィン", desc: "気づけば3時間経過" },
            { name: "タブ開きすぎ", desc: "100個開いて収拾つかず" },
            { name: "ブックマーク溜め込み", desc: "後で読むは読まない" },
            { name: "メール未読999+", desc: "整理できない性格" },
            { name: "LINE未読放置", desc: "返すの面倒で放置" },
            { name: "カート放置", desc: "買い物カゴに入れっぱなし" },
            { name: "セール依存", desc: "割引じゃないと買えない" },
            { name: "ポイント執着", desc: "ポイントのために無駄遣い" },
            { name: "レビュー読み過ぎ", desc: "決められず永遠リサーチ" },
            { name: "比較サイト巡り", desc: "最安値探しで疲弊" },
            { name: "無料期間だけ", desc: "課金はしない主義" },
            { name: "クーポン乞食", desc: "クーポンありきで選ぶ" },
            { name: "試供品コレクター", desc: "無料サンプル集め" },
            { name: "ガチャ欲", desc: "あと1回引きたい衝動" },
            { name: "課金沼", desc: "気づけば諭吉が消える" },
            { name: "推し活破産", desc: "推しのためなら財布が軽く" },
            { name: "積みゲー", desc: "買うだけでやらないゲーム" },
            { name: "積ん読", desc: "買うだけで読まない本" },
            { name: "サブスク放置", desc: "使ってないのに解約しない" },
            { name: "ダラダラ視聴", desc: "目的もなくNetflix" },
            { name: "自動再生の罠", desc: "次の話が勝手に始まる沼" },
            { name: "おすすめアルゴリズム中毒", desc: "AIに操られる日々" },
            { name: "無限スクロール", desc: "終わりのないタイムライン" },
            { name: "今日も何もしなかった", desc: "1日が終わる虚無感" },
            { name: "明日こそは", desc: "明日も同じことを言う" },
            { name: "いつかやる", desc: "いつかは永遠に来ない" },
            { name: "なんとかなる精神", desc: "準備不足の楽観主義" }
        ];

        // 禅の名言
        const ZEN_QUOTES = [
            "心頭滅却すれば火もまた涼し",
            "無心の境地に至る",
            "一切皆空",
            "色即是空 空即是色",
            "煩悩即菩提",
            "無",
            "空",
            "悟",
            "浄",
            "解脱への道",
            "執着を手放す",
            "今この瞬間に在る",
            "全ては移ろいゆく",
            "静寂の中に真理あり",
            "心を鎮めよ"
        ];

        // Canvas setup
        const mainCanvas = document.getElementById('mainCanvas');
        const particleCanvas = document.getElementById('particleCanvas');
        const effectCanvas = document.getElementById('effectCanvas');

        const mainCtx = mainCanvas.getContext('2d');
        const particleCtx = particleCanvas.getContext('2d');
        const effectCtx = effectCanvas.getContext('2d');

        function resizeCanvases() {
            [mainCanvas, particleCanvas, effectCanvas].forEach(canvas => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }
        resizeCanvases();
        window.addEventListener('resize', resizeCanvases);

        // Game state
        let keystrokeCount = 0;
        let totalKeystrokes = 0;
        let purifiedBonnou = 0;
        let currentBonnouIndex = 0;
        let typedText = '';
        const MAX_TYPED_LENGTH = 50;

        // Particles
        class Particle {
            constructor(x, y, type = 'sakura') {
                this.x = x;
                this.y = y;
                this.type = type;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = Math.random() * 2 + 1;
                this.size = Math.random() * 8 + 4;
                this.alpha = 1;
                this.rotation = Math.random() * Math.PI * 2;
                this.rotationSpeed = (Math.random() - 0.5) * 0.1;
                this.life = 1;

                if (type === 'light') {
                    this.color = `hsl(${Math.random() * 60 + 40}, 100%, 70%)`;
                    this.vy = -Math.random() * 3 - 1;
                } else if (type === 'kanji') {
                    this.kanji = ['無', '空', '悟', '浄', '禅'][Math.floor(Math.random() * 5)];
                    this.size = Math.random() * 30 + 20;
                    this.vx = (Math.random() - 0.5) * 4;
                    this.vy = -Math.random() * 4 - 2;
                } else if (type === 'explosion') {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 10 + 5;
                    this.vx = Math.cos(angle) * speed;
                    this.vy = Math.sin(angle) * speed;
                    this.color = `hsl(${Math.random() * 360}, 100%, 60%)`;
                    this.size = Math.random() * 15 + 5;
                }
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.rotation += this.rotationSpeed;

                if (this.type === 'sakura') {
                    this.vx += Math.sin(Date.now() * 0.001 + this.x * 0.01) * 0.1;
                } else if (this.type === 'light') {
                    this.alpha -= 0.01;
                    this.life -= 0.01;
                } else if (this.type === 'kanji' || this.type === 'explosion') {
                    this.alpha -= 0.02;
                    this.vy += 0.2;
                    this.life -= 0.02;
                }

                return this.y < window.innerHeight + 50 && this.alpha > 0 && this.life > 0;
            }

            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);

                if (this.type === 'sakura') {
                    // 桜の花びら
                    ctx.fillStyle = '#ffb7d5';
                    for (let i = 0; i < 5; i++) {
                        ctx.beginPath();
                        const angle = (i * Math.PI * 2) / 5;
                        ctx.arc(Math.cos(angle) * this.size * 0.3, Math.sin(angle) * this.size * 0.3,
                               this.size * 0.5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else if (this.type === 'light') {
                    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, this.size);
                    gradient.addColorStop(0, this.color);
                    gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(-this.size, -this.size, this.size * 2, this.size * 2);
                } else if (this.type === 'kanji') {
                    ctx.font = `${this.size}px serif`;
                    ctx.fillStyle = '#ffd93d';
                    ctx.strokeStyle = '#6c5ce7';
                    ctx.lineWidth = 2;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.strokeText(this.kanji, 0, 0);
                    ctx.fillText(this.kanji, 0, 0);
                } else if (this.type === 'explosion') {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            }
        }

        let particles = [];

        // 常時桜を生成
        setInterval(() => {
            for (let i = 0; i < 3; i++) {
                particles.push(new Particle(Math.random() * window.innerWidth, -20, 'sakura'));
            }
        }, 200);

        // 光の粒子を生成
        setInterval(() => {
            particles.push(new Particle(
                Math.random() * window.innerWidth,
                window.innerHeight + 20,
                'light'
            ));
        }, 100);

        // Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let masterGain = audioContext.createGain();
        masterGain.gain.value = 0.3;
        masterGain.connect(audioContext.destination);

        // ベルの音
        function playBell(frequency = 440) {
            const oscillator = audioContext.createOscillator();
            const gain = audioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

            gain.gain.setValueAtTime(0.3, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2);

            oscillator.connect(gain);
            gain.connect(masterGain);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 2);
        }

        // 特別な効果音
        function playSpecialSound() {
            // 複数の音を重ねて神秘的な音を作る
            [523.25, 659.25, 783.99].forEach((freq, i) => {
                setTimeout(() => playBell(freq), i * 100);
            });
        }

        // 環境音（99 BPMのリズム）
        let ambientInterval;
        function startAmbient() {
            const bpm = 99;
            const interval = (60 / bpm) * 1000;

            ambientInterval = setInterval(() => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.type = 'sine';
                osc.frequency.value = 110;
                gain.gain.value = 0.05;

                osc.connect(gain);
                gain.connect(masterGain);

                gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);

                osc.start();
                osc.stop(audioContext.currentTime + 0.1);
            }, interval);
        }

        // UI更新
        function updateUI() {
            document.getElementById('counter').textContent = keystrokeCount;
            document.getElementById('totalKeys').textContent = totalKeystrokes;
            document.getElementById('purifiedCount').textContent = purifiedBonnou;
            document.getElementById('enlightenmentLevel').textContent = purifiedBonnou;
            document.getElementById('progressText').textContent = `${purifiedBonnou}/99`;
            document.getElementById('progressFill').style.width = `${(purifiedBonnou / 99) * 100}%`;

            const bonnou = BONNOU_LIST[currentBonnouIndex];
            document.getElementById('bonnouName').textContent = bonnou.name;
            document.getElementById('bonnouDesc').textContent = bonnou.description;
        }

        // 禅の言葉を表示
        function showZenQuote() {
            const quote = ZEN_QUOTES[Math.floor(Math.random() * ZEN_QUOTES.length)];
            const element = document.getElementById('zenQuote');
            element.textContent = quote;
            element.style.opacity = '1';
            element.style.animation = 'none';
            setTimeout(() => {
                element.style.animation = 'celebrate 3s ease-out';
            }, 10);

            setTimeout(() => {
                element.style.opacity = '0';
            }, 3000);

            // 音声読み上げ
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(quote);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.8;
                utterance.pitch = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        // 99回の区切りエフェクト
        function triggerPurificationEffect() {
            // 画面全体にエフェクト
            for (let i = 0; i < 99; i++) {
                particles.push(new Particle(
                    window.innerWidth / 2,
                    window.innerHeight / 2,
                    'explosion'
                ));
            }

            // 漢字パーティクル
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    particles.push(new Particle(
                        Math.random() * window.innerWidth,
                        Math.random() * window.innerHeight,
                        'kanji'
                    ));
                }, i * 50);
            }

            // 画面フラッシュ
            let flashAlpha = 0.8;
            const fadeFlash = setInterval(() => {
                effectCtx.clearRect(0, 0, effectCanvas.width, effectCanvas.height);
                if (flashAlpha > 0) {
                    effectCtx.fillStyle = `rgba(255, 255, 255, ${flashAlpha})`;
                    effectCtx.fillRect(0, 0, effectCanvas.width, effectCanvas.height);
                    flashAlpha -= 0.05;
                } else {
                    effectCtx.clearRect(0, 0, effectCanvas.width, effectCanvas.height);
                    clearInterval(fadeFlash);
                }
            }, 30);

            playSpecialSound();
            showZenQuote();

            // 祝福テキスト
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.textContent = '✨浄化✨';
            document.body.appendChild(celebration);
            setTimeout(() => celebration.remove(), 2000);
        }

        // 最終悟りエフェクト
        function triggerEnlightenment() {
            document.getElementById('enlightenmentScreen').style.display = 'flex';

            // 超派手なエフェクト
            for (let i = 0; i < 200; i++) {
                setTimeout(() => {
                    particles.push(new Particle(
                        Math.random() * window.innerWidth,
                        Math.random() * window.innerHeight,
                        Math.random() > 0.5 ? 'explosion' : 'kanji'
                    ));
                }, i * 20);
            }

            // 連続ベル
            for (let i = 0; i < 9; i++) {
                setTimeout(() => {
                    playSpecialSound();
                }, i * 500);
            }

            if ('speechSynthesis' in window) {
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance('おめでとうございます。ほぼ悟りの境地に達しました。');
                    utterance.lang = 'ja-JP';
                    utterance.rate = 0.9;
                    speechSynthesis.speak(utterance);
                }, 1000);
            }
        }

        // キーボードイベント
        document.addEventListener('keydown', (e) => {
            if (purifiedBonnou >= 99) return;

            // 音声コンテキストを開始（最初のユーザーインタラクションで必要）
            if (audioContext.state === 'suspended') {
                audioContext.resume();
                startAmbient();
            }

            keystrokeCount++;
            totalKeystrokes++;

            // 表示テキストは全て「無」
            typedText += '無';
            if (typedText.length > MAX_TYPED_LENGTH) {
                typedText = typedText.slice(-MAX_TYPED_LENGTH);
            }
            document.getElementById('typingArea').textContent = typedText;

            // パーティクル生成
            for (let i = 0; i < 3; i++) {
                particles.push(new Particle(
                    Math.random() * window.innerWidth,
                    Math.random() * window.innerHeight,
                    Math.random() > 0.7 ? 'kanji' : 'light'
                ));
            }

            // 小さな音
            playBell(440 + Math.random() * 220);

            // 99回ごとに煩悩を浄化
            if (keystrokeCount >= 99) {
                keystrokeCount = 0;
                purifiedBonnou++;
                currentBonnouIndex = purifiedBonnou % BONNOU_LIST.length;

                triggerPurificationEffect();

                // 全て浄化完了
                if (purifiedBonnou >= 99) {
                    setTimeout(() => {
                        triggerEnlightenment();
                    }, 2000);
                }
            }

            updateUI();
        });

        // 背景アニメーション
        function drawBackground() {
            const gradient = mainCtx.createLinearGradient(0, 0, 0, mainCanvas.height);
            gradient.addColorStop(0, '#1a0a2e');
            gradient.addColorStop(0.5, '#0f0518');
            gradient.addColorStop(1, '#2a1a3a');
            mainCtx.fillStyle = gradient;
            mainCtx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);

            // 神秘的な光のオーラ
            const time = Date.now() * 0.001;
            for (let i = 0; i < 3; i++) {
                const x = mainCanvas.width / 2 + Math.sin(time + i * 2) * 200;
                const y = mainCanvas.height / 2 + Math.cos(time + i * 2) * 150;
                const gradient = mainCtx.createRadialGradient(x, y, 0, x, y, 300);
                gradient.addColorStop(0, `rgba(108, 92, 231, ${0.1 + Math.sin(time) * 0.05})`);
                gradient.addColorStop(1, 'rgba(108, 92, 231, 0)');
                mainCtx.fillStyle = gradient;
                mainCtx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);
            }
        }

        // アニメーションループ
        function animate() {
            drawBackground();

            // パーティクル更新
            particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
            particles = particles.filter(particle => {
                const alive = particle.update();
                if (alive) particle.draw(particleCtx);
                return alive;
            });

            requestAnimationFrame(animate);
        }

        // 初期化
        updateUI();
        animate();

        // ローカルストレージから進捗を読み込み
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('bonnou99Progress');
            if (saved) {
                const data = JSON.parse(saved);
                totalKeystrokes = data.totalKeystrokes || 0;
                purifiedBonnou = data.purifiedBonnou || 0;
                currentBonnouIndex = purifiedBonnou % BONNOU_LIST.length;
                updateUI();
            }
        });

        // 進捗を定期保存
        setInterval(() => {
            localStorage.setItem('bonnou99Progress', JSON.stringify({
                totalKeystrokes,
                purifiedBonnou
            }));
        }, 5000);

        // 99秒ごとに禅の言葉
        setInterval(() => {
            if (purifiedBonnou < 99 && totalKeystrokes > 0) {
                showZenQuote();
            }
        }, 99000);
    </script>
</body>
</html>
