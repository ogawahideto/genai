<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±æµ·é“äº”åä¸‰æ¬¡ã™ã”ã‚ãã‚²ãƒ¼ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            color: #333;
        }

        .game-title {
            text-align: center;
            font-size: 2.8em;
            color: #8B0000;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-subtitle {
            text-align: center;
            font-size: 1.3em;
            color: #8B4513;
            margin-bottom: 30px;
            font-style: italic;
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: linear-gradient(45deg, #fff8dc, #f0e68c);
            border: 2px solid #DAA520;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .info-card h3 {
            color: #8B4513;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .info-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #8B0000;
        }

        .game-board {
            background: linear-gradient(45deg, #f5f5dc, #fffacd);
            border: 3px solid #8B4513;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            position: relative;
        }

        .stations-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .station {
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 8px 4px;
            text-align: center;
            font-size: 0.85em;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .station:hover {
            background: #fffacd;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .station.current {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-color: #FF8C00;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            transform: scale(1.1);
        }

        .station.visited {
            background: linear-gradient(45deg, #90EE90, #98FB98);
            border-color: #228B22;
        }

        .station.event-station::after {
            content: 'ğŸª';
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 1.2em;
        }
        
        .station.market-station::before {
            content: 'ğŸ’°';
            position: absolute;
            bottom: 2px;
            left: 2px;
            font-size: 1.2em;
        }

        .station-number {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 2px;
        }

        .station-name {
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
        }

        .player-token {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #FF4500;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .dice-area {
            text-align: center;
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(45deg, #f0f8ff, #e6f3ff);
            border-radius: 15px;
            border: 2px solid #4169E1;
        }

        .dice {
            font-size: 4em;
            margin: 15px;
            padding: 20px;
            background: white;
            border: 3px solid #333;
            border-radius: 15px;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .dice.rolling {
            animation: roll 0.5s ease-in-out;
        }

        @keyframes roll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-primary {
            background: linear-gradient(45deg, #8B4513, #A0522D);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(45deg, #654321, #8B4513);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #DAA520, #FFD700);
            color: #8B4513;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(45deg, #B8860B, #DAA520);
            transform: translateY(-2px);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            display: none;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            border: 4px solid #8B4513;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal-content h3 {
            color: #8B0000;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .modal-content p {
            color: #333;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        #modal-choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .shop-item, .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .item-info {
            text-align: left;
        }


        .progress-bar {
            background: #ddd;
            border-radius: 10px;
            padding: 3px;
            margin: 20px 0;
        }

        .progress-fill {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            height: 20px;
            border-radius: 8px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9em;
            font-weight: bold;
        }

        .rules-section {
            background: linear-gradient(45deg, #f9f5dc, #fff8dc);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border-left: 5px solid #8B4513;
        }

        .rules-section h3 {
            color: #8B4513;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .rules-section ul {
            margin-left: 20px;
            color: #654321;
        }

        .rules-section li {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .game-title {
                font-size: 2.2em;
            }
            
            .stations-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 6px;
            }
            
            .station {
                font-size: 0.75em;
                min-height: 50px;
                padding: 6px 2px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!--
    AI Model: Gemini
    User Prompt: tokaido-53-gameã‚’ã‚‚ã£ã¨é¢ç™½ãã—ã¦ãã ã•ã„ (A&C), æˆ»ã£ã¦ã—ã¾ã†ã‚¤ãƒ™ãƒ³ãƒˆã‚‚åŠ ãˆã¦ãã ã•ã„, å®¿å ´ã®ç‰¹å¾´ã‚’æ´»ã‹ã—ãŸè¨­å®šã«ã—ã¦ãã ã•ã„
    AI Approach: æ—¢å­˜ã®ã™ã”ã‚ãã‚²ãƒ¼ãƒ ã«ã€æ¡ˆAã€Œã‚¢ã‚¤ãƒ†ãƒ å±‹ã¨ã€ä½¿ã†ã€ã‚¢ã‚¤ãƒ†ãƒ ã®å°å…¥ã€ã¨æ¡ˆCã€Œå®¿å ´ã”ã¨ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã€ã‚’å®Ÿè£…ã€‚ã•ã‚‰ã«ã€å®¿å ´ã®ç‰¹å¾´ã«åˆã‚ã›ãŸã€Œå¾Œé€€ã‚¤ãƒ™ãƒ³ãƒˆã€ã‚’è¿½åŠ ã€‚
    JavaScriptã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å¤§å¹…ã«å¤‰æ›´ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆã¨ã‚¢ã‚¤ãƒ†ãƒ ã®ç®¡ç†ã‚’å¼·åŒ–ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¸æŠè‚¢ã¨ã€äºˆæœŸã›ã¬å¾Œé€€ã®ãƒªã‚¹ã‚¯ã‚’åŠ ãˆã¦æˆ¦ç•¥æ€§ã‚’é«˜ã‚ã‚‹ã€‚
    Implementation Intent: ã‚²ãƒ¼ãƒ ã®å˜èª¿ã•ã‚’ãªãã—ã€ãƒªãƒ—ãƒ¬ã‚¤æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã€‚ãŠé‡‘ã®ä½¿ã„é“ã€ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨ã€ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠã®é‡è¦æ€§ã‚’é«˜ã‚ã€ã‚ˆã‚Šã‚¹ãƒªãƒªãƒ³ã‚°ãªã‚²ãƒ¼ãƒ ä½“é¨“ã‚’æä¾›ã™ã‚‹ã€‚
    -->

    <div class="game-container">
        <h1 class="game-title">ğŸ® æ±æµ·é“äº”åä¸‰æ¬¡ã™ã”ã‚ã ğŸ®</h1>
        <p class="game-subtitle">æ±Ÿæˆ¸ã‹ã‚‰äº¬éƒ½ã¾ã§53ã®å®¿å ´ç”ºã‚’å·¡ã‚‹å¤§å†’é™ºï¼</p>

        <div class="game-info">
            <div class="info-card">
                <h3>ç¾åœ¨åœ°</h3>
                <div class="value" id="current-station">æ±Ÿæˆ¸ãƒ»æ—¥æœ¬æ©‹</div>
            </div>
            <div class="info-card">
                <h3>å®¿å ´æ•°</h3>
                <div class="value"><span id="station-count">1</span>/55</div>
            </div>
            <div class="info-card">
                <h3>æ‰€æŒé‡‘</h3>
                <div class="value" id="money">1000ä¸¡</div>
            </div>
            <div class="info-card">
                <h3>æ—¥æ•°</h3>
                <div class="value" id="days">0æ—¥</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress" style="width: 2%;">
                æ—…è·¯é€²è¡Œåº¦
            </div>
        </div>

        <div class="game-board">
            <div class="stations-grid" id="stations-grid">
                <!-- å®¿å ´ç”ºã¯JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>

        <div class="dice-area">
            <div class="dice" id="dice">ğŸ²</div>
            <div style="margin-top: 15px;">
                <button class="btn btn-primary" id="roll-btn" onclick="rollDice()">ğŸ² ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</button>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-secondary" onclick="showStationInfo()">ğŸ—¾ å®¿å ´æƒ…å ±</button>
            <button class="btn btn-secondary" id="shop-btn" onclick="showShop()" style="display: none;">ğŸ’° ã‚¢ã‚¤ãƒ†ãƒ å±‹</button>
            <button class="btn btn-secondary" onclick="showInventory()">ğŸ’ æŒã¡ç‰©</button>
            <button class="btn btn-primary" onclick="resetGame()">ğŸ”„ æ–°ã—ã„æ—…</button>
        </div>

        <div class="rules-section">
            <h3>ğŸ¯ ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«</h3>
            <ul>
                <li>ğŸ² ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦æ±æµ·é“ã‚’é€²ã¿ã¾ã™</li>
                <li>ğŸ¨ å®¿å ´ç”ºã§ã¯ã‚¢ã‚¤ãƒ†ãƒ ã®å£²è²·ãŒã§ãã¾ã™</li>
                <li>ğŸ’° ãŠé‡‘ã‚’ç®¡ç†ã—ãªãŒã‚‰äº¬éƒ½ã‚’ç›®æŒ‡ã—ã¾ã™</li>
                <li>ğŸª ç‰¹å®šã®å®¿å ´ã§ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã™</li>
                <li>â›©ï¸ å…¨55åœ°ç‚¹åˆ¶è¦‡ã§å‹åˆ©ï¼</li>
            </ul>
        </div>
    </div>

    <!-- æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 id="modal-title">ã‚¿ã‚¤ãƒˆãƒ«</h3>
            <p id="modal-description">èª¬æ˜</p>
            <div id="modal-list"></div>
            <div id="modal-choices"></div>
        </div>
    </div>

    <script>
        const TOKAIDO_STATIONS = [
            { name: "æ±Ÿæˆ¸ãƒ»æ—¥æœ¬æ©‹", description: "æ—…ã®å‡ºç™ºç‚¹", market: true, event: 'start' },
            { name: "å“å·å®¿", description: "æ±Ÿæˆ¸å››å®¿ã®ä¸€ã¤" },
            { name: "å·å´å®¿", description: "å¤šæ‘©å·ã®æ¸¡ã—å ´", event: 'kawasaki_ferry' },
            { name: "ç¥å¥ˆå·å®¿", description: "æ¨ªæµœæ¸¯ã«è¿‘ã„å®¿å ´", market: true },
            { name: "ä¿åœŸãƒ¶è°·å®¿", description: "å‚é“ã®å¤šã„å®¿å ´", event: 'hodogaya_slope' },
            { name: "æˆ¸å¡šå®¿", description: "ç®±æ ¹è·¯ã¸ã®åˆ†å²ç‚¹" },
            { name: "è—¤æ²¢å®¿", description: "éŠè¡Œå¯ºã§æœ‰å", market: true },
            { name: "å¹³å¡šå®¿", description: "ä¸ƒå¤•ã¾ã¤ã‚Šã®è¡—" },
            { name: "å¤§ç£¯å®¿", description: "æµ·æ²¿ã„ã®ç¾ã—ã„å®¿å ´" },
            { name: "å°ç”°åŸå®¿", description: "å°ç”°åŸåŸã®åŸä¸‹ç”º", market: true, event: 'castle' },
            { name: "ç®±æ ¹å®¿", description: "å¤©ä¸‹ã®é™ºã€ç®±æ ¹å…«é‡Œ", event: 'hakone' },
            { name: "ä¸‰å³¶å®¿", description: "ä¼Šè±†å›½ã®ç„é–¢å£" },
            { name: "æ²¼æ´¥å®¿", description: "é§¿æ²³æ¹¾ã«é¢ã—ãŸå®¿å ´" },
            { name: "åŸå®¿", description: "å¯Œå£«å±±ãŒã‚ˆãè¦‹ãˆã‚‹", event: 'fuji' },
            { name: "å‰åŸå®¿", description: "å¯Œå£«å±±ã®çµ¶æ™¯ã‚¹ãƒãƒƒãƒˆ", market: true },
            { name: "è’²åŸå®¿", description: "é›ªæ™¯è‰²ã§æœ‰å" },
            { name: "ç”±æ¯”å®¿", description: "è–©åŸµå³ ã®é›£æ‰€" },
            { name: "èˆˆæ´¥å®¿", description: "æ¸…è¦‹å¯ºã§æœ‰å" },
            { name: "æ±Ÿå°»å®¿", description: "æ¸…æ°´æ¸¯ã«è¿‘ã„" },
            { name: "åºœä¸­å®¿", description: "é§¿åºœåŸã®åŸä¸‹ç”º", market: true, event: 'castle' },
            { name: "é å­å®¿", description: "ã¨ã‚ã‚æ±ã§æœ‰å", event: 'food' },
            { name: "å²¡éƒ¨å®¿", description: "å®‡æ´¥ãƒè°·å³ è¶Šãˆ" },
            { name: "è—¤æå®¿", description: "ç”°ä¸­åŸã«è¿‘ã„" },
            { name: "å³¶ç”°å®¿", description: "å¤§äº•å·ã®å·è¶Šã—", event: 'ooi_river' },
            { name: "é‡‘è°·å®¿", description: "ç‰§ãƒåŸå°åœ°ã®å…¥å£" },
            { name: "æ—¥å‚å®¿", description: "å°å¤œã®ä¸­å±±è¶Šãˆ", event: 'nissaka_pass' },
            { name: "æ›å·å®¿", description: "æ›å·åŸã®åŸä¸‹ç”º", market: true },
            { name: "è¢‹äº•å®¿", description: "æ±æµ·é“ã®ã©çœŸã‚“ä¸­" },
            { name: "è¦‹ä»˜å®¿", description: "å¤©ç«œå·ã«è¿‘ã„", event: 'river' },
            { name: "æµœæ¾å®¿", description: "æµœæ¾åŸã®åŸä¸‹ç”º", market: true, event: 'castle' },
            { name: "èˆå‚å®¿", description: "æµœåæ¹–ç•”ã®å®¿å ´" },
            { name: "æ–°å±…å®¿", description: "æ–°å±…é–¢æ‰€ã§æœ‰å", event: 'sekisho' },
            { name: "ç™½é ˆè³€å®¿", description: "æ½®è¦‹å‚ã®çµ¶æ™¯" },
            { name: "äºŒå·å®¿", description: "æœ¬é™£ãŒç¾å­˜" },
            { name: "å‰ç”°å®¿", description: "å‰ç”°åŸã®åŸä¸‹ç”º" },
            { name: "å¾¡æ²¹å®¿", description: "æ¾ä¸¦æœ¨ãŒç¾ã—ã„" },
            { name: "èµ¤å‚å®¿", description: "æ‰ä¸¦æœ¨ã®å®¿å ´" },
            { name: "è—¤å·å®¿", description: "ã‚€ã‚‰ã•ãéº¦ã§æœ‰å" },
            { name: "å²¡å´å®¿", description: "å¾³å·å®¶åº·ç”Ÿèª•ã®åœ°", market: true, event: 'ieyasu' },
            { name: "æ± é¯‰é®’å®¿", description: "é¦¬å¸‚ã§è³‘ã‚ã†" },
            { name: "é³´æµ·å®¿", description: "æœ‰æ¾çµã‚Šã§æœ‰å", event: 'narumi_shibori' },
            { name: "å®®å®¿", description: "ç†±ç”°ç¥å®®ã®é–€å‰ç”º", event: 'miya' },
            { name: "æ¡‘åå®¿", description: "ä¸ƒé‡Œã®æ¸¡ã—", market: true },
            { name: "å››æ—¥å¸‚å®¿", description: "æ¸¯ç”ºã¨ã—ã¦æ „ãˆã‚‹" },
            { name: "çŸ³è–¬å¸«å®¿", description: "è–¬å¸«å¦‚æ¥ã§æœ‰å" },
            { name: "åº„é‡å®¿", description: "ç™½é›¨ã®åæ‰€" },
            { name: "äº€å±±å®¿", description: "äº€å±±åŸã®åŸä¸‹ç”º" },
            { name: "é–¢å®¿", description: "æ±æµ·é“ã®é–¢æ‰€", event: 'sekisho' },
            { name: "å‚ä¸‹å®¿", description: "éˆ´é¹¿å³ ã®éº“" },
            { name: "åœŸå±±å®¿", description: "éˆ´é¹¿å³ è¶Šãˆã®å®¿å ´", event: 'suzuka' },
            { name: "æ°´å£å®¿", description: "æ°´å£åŸã®åŸä¸‹ç”º" },
            { name: "çŸ³éƒ¨å®¿", description: "ç”°æ¥½ã§æœ‰å", event: 'food' },
            { name: "è‰æ´¥å®¿", description: "ä¸­å±±é“ã¨ã®åˆæµç‚¹", market: true, event: 'kusatsu_junction' },
            { name: "å¤§æ´¥å®¿", description: "çµç¶æ¹–ç•”ã®å®¿å ´" },
            { name: "äº¬éƒ½ãƒ»ä¸‰æ¡å¤§æ©‹", description: "æ—…ã®çµ‚ç€ç‚¹", event: 'goal' }
        ];

        const ITEMS = {
            'dango': { name: 'åç‰©ã®å›£å­', cost: 50, description: 'æ¬¡ã®ã‚µã‚¤ã‚³ãƒ­ã®ç›®ã‚’+1ã™ã‚‹ã€‚' },
            'waraji': { name: 'ä¸ˆå¤«ãªè‰é‹', cost: 100, description: '3ã‚¿ãƒ¼ãƒ³ã®é–“ã€ç§»å‹•ã‚³ã‚¹ãƒˆ(ä¸¡)ãŒåŠé¡ã«ãªã‚‹ã€‚' },
            'omamori': { name: 'ãŠå®ˆã‚Š', cost: 200, description: 'æ‚ªã„ã‚¤ãƒ™ãƒ³ãƒˆã®çµæœã‚’1å›ã ã‘å›é¿ã§ãã‚‹ã€‚' },
            'map': { name: 'å¤åœ°å›³', cost: 300, description: 'æ¬¡ã®ç§»å‹•ã§1ï½3ã®å¥½ããªæ•°ã ã‘é€²ã‚ã‚‹ã€‚' },
            'shibori': { name: 'æœ‰æ¾çµ', cost: 0, description: 'é³´æµ·å®¿ã®ç¾ã—ã„ç‰¹ç”£å“ã€‚æ—…ã®è©•ä¾¡ã«å½±éŸ¿ã™ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚' }
        };
        
        const EVENTS = {
            'hodogaya_slope': {
                title: "æ¨©å¤ªå‚ã®æ‚²åŠ‡",
                description: "æ¨©å¤ªå‚ã®æ€¥ãªä¸‹ã‚Šå‚ã§è¶³ã‚’æ»‘ã‚‰ã›ã€è·ç‰©ã‚’è½ã¨ã—ã¦ã—ã¾ã£ãŸï¼ è·ç‰©ã‚’æ‹¾ã†ãŸã‚ã€1ã¤æ‰‹å‰ã®ç¥å¥ˆå·å®¿ã¾ã§æˆ»ã‚‹ç¾½ç›®ã«ãªã£ãŸã€‚",
                choices: [
                    { text: "ä»•æ–¹ãªã„ã€æˆ»ã‚ã† (-1ãƒã‚¹)", effect: { steps: -1 } }
                ]
            },
            'nissaka_pass': {
                title: "å°å¤œã®ä¸­å±±ã®è¿·ã„é“",
                description: "å°å¤œã®ä¸­å±±ã§ä¸æ°—å‘³ãªé›°å›²æ°—ã‚’æ„Ÿã˜ã€é“ã‚’é–“é•ãˆã¦ã—ã¾ã£ãŸï¼ æ°—ã¥ã‘ã°2ã¤æ‰‹å‰ã®é‡‘è°·å®¿ã¾ã§æˆ»ã£ã¦ãã¦ã—ã¾ã£ãŸã€‚",
                choices: [
                    { text: "é“ã‚’é–“é•ãˆãŸã‹â€¦ (-2ãƒã‚¹, +1æ—¥)", effect: { steps: -2, days: 1 } }
                ]
            },
            'kawasaki_ferry': {
                title: "å¤šæ‘©å·ã®æ¸¡ã—",
                description: "å¤šæ‘©å·ã‚’æ¸¡ã‚‹æ¸¡ã—èˆ¹ã ã€‚èˆ¹é ­ãŒæ–™é‡‘(50ä¸¡)ã‚’æç¤ºã—ã¦ã„ã‚‹ã€‚",
                choices: [
                    { text: "æ­£è¦æ–™é‡‘ã‚’æ‰•ã† (-50ä¸¡)", effect: { money: -50 }, cost: 50 },
                    { text: "å€¤åˆ‡ã‚Šäº¤æ¸‰ã™ã‚‹", type: 'haggle', success: { text: "äº¤æ¸‰æˆåŠŸï¼(-30ä¸¡)", effect: { money: -30 } }, failure: { text: "äº¤æ¸‰å¤±æ•—â€¦(+1æ—¥)", effect: { days: 1 } }, cost: 0 }
                ]
            },
            'narumi_shibori': {
                title: "æœ‰æ¾çµã‚Šã®èª˜æƒ‘",
                description: "ç¾ã—ã„æœ‰æ¾çµã‚Šã®åº—ãŒç›®ã«å…¥ã£ãŸã€‚è¦‹äº‹ãªå¸ƒã ãŒã€ã‹ãªã‚Šé«˜ä¾¡ã ã€‚",
                choices: [
                    { text: "è¨˜å¿µã«è³¼å…¥ã™ã‚‹ (-250ä¸¡)", effect: { item: 'shibori' }, cost: 250 },
                    { text: "é«˜ã™ãã‚‹ã®ã§è«¦ã‚ã‚‹", effect: {} }
                ]
            },
            'kusatsu_junction': {
                title: "ä¸­å±±é“ã¨ã®åˆæµç‚¹",
                description: "ä¸­å±±é“ã‹ã‚‰æ¥ãŸã¨ã„ã†æ—…äººã¨å‡ºä¼šã£ãŸã€‚ä½•ã‹æƒ…å ±ã‚’äº¤æ›ã—ãªã„ã‹ã€ã¨æŒã¡ã‹ã‘ã‚‰ã‚ŒãŸã€‚",
                choices: [
                    { text: "æƒ…å ±äº¤æ›ã™ã‚‹", type: 'gamble', success: { text: "è¿‘é“ç™ºè¦‹ï¼(-1æ—¥)", effect: { days: -1 } }, failure: { text: "ã»ã‚‰è©±ã ã£ãŸâ€¦(-50ä¸¡)", effect: { money: -50 } } },
                    { text: "é–¢ã‚ã‚‰ãšã«å…ˆã‚’æ€¥ã", effect: {} }
                ]
            },
            'hakone': {
                title: "å¤©ä¸‹ã®é™ºã€ç®±æ ¹å…«é‡Œ",
                description: "é™ºã—ã„å±±é“ãŒç›®ã®å‰ã«ï¼ã©ã†ã‚„ã£ã¦è¶Šãˆã¾ã™ã‹ï¼Ÿ",
                choices: [
                    { text: "è‡ªåŠ›ã§è¶Šãˆã‚‹ (+2æ—¥)", effect: { days: 2 } },
                    { text: "é§•ç± ã‚’é›‡ã† (-150ä¸¡)", effect: { money: -150 }, cost: 150 },
                    { text: "ä¸ˆå¤«ãªè‰é‹ã‚’ä½¿ã†", effect: { days: 1 }, requiredItem: 'waraji' }
                ]
            },
            'ooi_river': {
                title: "å¤§äº•å·ã®å·ç•™ã‚",
                description: "å·ãŒå¢—æ°´ã—ã¦æ¸¡ã‚Œã¾ã›ã‚“ï¼ã©ã†ã—ã¾ã™ã‹ï¼Ÿ",
                choices: [
                    { text: "æ•°æ—¥å¾…ã¤ (+3æ—¥)", effect: { days: 3 } },
                    { text: "å·è¶Šäººè¶³ã‚’é›‡ã† (-200ä¸¡)", effect: { money: -200 }, cost: 200 },
                    { text: "å¤åœ°å›³ã®è£é“ã‚’è¡Œã", effect: { days: 1, money: -50 }, requiredItem: 'map', cost: 50 }
                ]
            },
            'ieyasu': {
                title: "å¾³å·å®¶åº·ç”Ÿèª•ã®åœ°",
                description: "å²¡å´åŸä¸‹ã§å°†è»å®¶ã‚†ã‹ã‚Šã®å“ã‚’ç™ºè¦‹ï¼å¹¸é‹ãŒèˆã„è¾¼ã‚“ã ï¼",
                choices: [
                    { text: "ã‚ã‚ŠãŒãŸãé ‚æˆ´ã™ã‚‹ (+200ä¸¡)", effect: { money: 200 } }
                ]
            },
            'food': {
                title: "åç‰©æ–™ç†",
                description: "ç¾å‘³ã—ãã†ãªåç‰©æ–™ç†ãŒã‚ã‚Šã¾ã™ã€‚é£Ÿã¹ã¦ã„ãã¾ã™ã‹ï¼Ÿ",
                choices: [
                    { text: "é£Ÿã¹ã‚‹ (-50ä¸¡, +1æ—¥)", effect: { money: -50, days: 1 }, cost: 50 },
                    { text: "å…ˆã‚’æ€¥ã", effect: {} }
                ]
            },
             'sekisho': {
                title: "é–¢æ‰€ã§ã®æ¤œå•",
                description: "é–¢æ‰€ã§å½¹äººã«ã‚ˆã‚‹å³ã—ã„æ¤œå•ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚",
                choices: [
                    { text: "ç´ ç›´ã«é€šã‚‹ (-20ä¸¡, +1æ—¥)", effect: { money: -20, days: 1 }, cost: 20 },
                    { text: "è¢–ã®ä¸‹ã‚’ä½¿ã† (-100ä¸¡)", effect: { money: -100 }, cost: 100 }
                ]
            }
        };

        let gameState;

        function initGame() {
            gameState = {
                currentPosition: 0,
                money: 1000,
                days: 0,
                inventory: [],
                visitedStations: [0],
                isGameBlocked: false,
                activeEffects: {} // { 'waraji': 3, 'dice_bonus': 1 }
            };
            
            renderStations();
            updateGameInfo();
            updateControls();
        }

        function renderStations() {
            const grid = document.getElementById('stations-grid');
            grid.innerHTML = '';
            
            TOKAIDO_STATIONS.forEach((station, index) => {
                const stationDiv = document.createElement('div');
                stationDiv.className = 'station';
                
                if (index === gameState.currentPosition) {
                    stationDiv.classList.add('current');
                    stationDiv.innerHTML = `<div class="player-token">ğŸš¶</div>`;
                } else if (gameState.visitedStations.includes(index)) {
                    stationDiv.classList.add('visited');
                }
                
                if (station.event) stationDiv.classList.add('event-station');
                if (station.market) stationDiv.classList.add('market-station');
                
                stationDiv.innerHTML += `
                    <div class="station-number">${index + 1}</div>
                    <div class="station-name">${station.name}</div>
                `;
                
                stationDiv.onclick = () => showStationDetail(index);
                grid.appendChild(stationDiv);
            });
        }

        function rollDice() {
            if (gameState.isGameBlocked) return;
            
            gameState.isGameBlocked = true;
            const dice = document.getElementById('dice');
            
            dice.classList.add('rolling');
            updateControls();
            
            let animationCount = 0;
            const animationInterval = setInterval(() => {
                dice.textContent = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'][Math.floor(Math.random() * 6)];
                animationCount++;
                
                if (animationCount > 10) {
                    clearInterval(animationInterval);
                    
                    let result = Math.floor(Math.random() * 6) + 1;
                    
                    if (gameState.activeEffects['dice_bonus']) {
                        result += gameState.activeEffects['dice_bonus'];
                        delete gameState.activeEffects['dice_bonus'];
                        showModal("ã‚¢ã‚¤ãƒ†ãƒ åŠ¹æœï¼", `åç‰©ã®å›£å­ã®ãŠã‹ã’ã§ã‚µã‚¤ã‚³ãƒ­ã®ç›®ãŒ+1ã•ã‚ŒãŸï¼`);
                    }

                    dice.textContent = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'][Math.min(5, result - 1)];
                    
                    setTimeout(() => {
                        dice.classList.remove('rolling');
                        movePlayer(result);
                    }, 500);
                }
            }, 100);
        }

        function movePlayer(steps) {
            gameState.isGameBlocked = true;
            updateControls();

            let newPosition = gameState.currentPosition + steps;
            newPosition = Math.max(0, newPosition);
            newPosition = Math.min(newPosition, TOKAIDO_STATIONS.length - 1);

            if (steps > 0) {
                let moveCost = steps * 10;
                if (gameState.activeEffects['cost_reduction']) {
                    moveCost /= 2;
                }
                gameState.money -= moveCost;
                gameState.days += Math.ceil(steps / 2);
            }
            
            gameState.currentPosition = newPosition;
            if (!gameState.visitedStations.includes(newPosition)) {
                gameState.visitedStations.push(newPosition);
            }

            Object.keys(gameState.activeEffects).forEach(effect => {
                if (effect === 'cost_reduction') {
                    gameState.activeEffects[effect]--;
                    if (gameState.activeEffects[effect] <= 0) {
                        delete gameState.activeEffects[effect];
                    }
                }
            });
            
            renderStations();
            updateGameInfo();
            
            const currentStation = TOKAIDO_STATIONS[newPosition];
            if (currentStation.event && EVENTS[currentStation.event] && steps > 0) {
                setTimeout(() => triggerEvent(currentStation.event), 500);
            } else {
                 gameState.isGameBlocked = false;
                 updateControls();
            }
            
            if (newPosition === TOKAIDO_STATIONS.length - 1) {
                setTimeout(showVictory, 1500);
            }
        }

        function triggerEvent(eventType) {
            const event = EVENTS[eventType];
            if (!event) {
                gameState.isGameBlocked = false;
                updateControls();
                return;
            }
            showModal(event.title, event.description, event.choices);
        }
        
        function resolveChoice(choice) {
            // Handle special choice types first
            if (choice.type === 'haggle' || choice.type === 'gamble') {
                const isSuccess = Math.random() < 0.5; // 50% chance
                const outcome = isSuccess ? choice.success : choice.failure;
                showModal(isSuccess ? "æˆåŠŸï¼" : "å¤±æ•—â€¦", outcome.text);
                choice = { effect: outcome.effect }; // Overwrite choice with the outcome
            }

            const isBadEvent = (choice.effect.money && choice.effect.money < 0) || (choice.effect.days && choice.effect.days > 0) || (choice.effect.steps && choice.effect.steps < 0);
            if (isBadEvent) {
                const omamoriIndex = gameState.inventory.findIndex(item => item === 'omamori');
                if (omamoriIndex !== -1) {
                    if (confirm("ãŠå®ˆã‚Šã‚’ä½¿ã„ã¾ã™ã‹ï¼Ÿæ‚ªã„çµæœã‚’æ‰“ã¡æ¶ˆã›ã¾ã™ã€‚")) {
                        gameState.inventory.splice(omamoriIndex, 1);
                        showModal("ãŠå®ˆã‚Šã®åŠ¹æœ", "ãŠå®ˆã‚ŠãŒæ‚ªã„å‡ºæ¥äº‹ã‹ã‚‰ã‚ãªãŸã‚’å®ˆã£ãŸï¼");
                        return;
                    }
                }
            }

            if (choice.effect.money) gameState.money += choice.effect.money;
            if (choice.effect.days) gameState.days += choice.effect.days;
            if (choice.effect.item) gameState.inventory.push(choice.effect.item);
            
            if (choice.requiredItem) {
                const itemIndex = gameState.inventory.findIndex(item => item === choice.requiredItem);
                if (itemIndex > -1) {
                    gameState.inventory.splice(itemIndex, 1);
                }
            }

            updateGameInfo();

            if (choice.effect.steps) {
                const stepsToMove = choice.effect.steps;
                // Do not close modal here, let the following modal call handle it
                setTimeout(() => movePlayer(stepsToMove), 500);
            } else {
                // For non-movement effects, we might have already shown a result modal
                if (!choice.type) {
                    closeModal();
                }
            }
        }

        function showModal(title, description, choices = []) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-description').innerHTML = description;
            
            const choicesDiv = document.getElementById('modal-choices');
            const listDiv = document.getElementById('modal-list');
            choicesDiv.innerHTML = '';
            listDiv.innerHTML = '';

            if (choices.length > 0) {
                choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-primary';
                    button.textContent = choice.text;
                    
                    const hasItem = choice.requiredItem ? gameState.inventory.includes(choice.requiredItem) : true;
                    const hasMoney = choice.cost ? gameState.money >= choice.cost : true;

                    if (hasItem && hasMoney) {
                        button.onclick = () => resolveChoice(choice);
                    } else {
                        button.disabled = true;
                        let reason = [];
                        if (!hasMoney) reason.push("ãŠé‡‘ãŒè¶³ã‚Šãªã„");
                        if (!hasItem) reason.push(`${ITEMS[choice.requiredItem].name}ãŒãªã„`);
                        button.textContent += ` (${reason.join(', ')})`;
                    }
                    choicesDiv.appendChild(button);
                });
            } else {
                 const button = document.createElement('button');
                 button.className = 'btn btn-primary';
                 button.textContent = 'ç¶šã‘ã‚‹';
                 button.onclick = closeModal;
                 choicesDiv.appendChild(button);
            }

            document.getElementById('modal').style.display = 'flex';
            gameState.isGameBlocked = true;
            updateControls();
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            gameState.isGameBlocked = false;
            updateControls();
        }
        
        function showShop() {
            const station = TOKAIDO_STATIONS[gameState.currentPosition];
            if (!station.market) return;

            document.getElementById('modal-title').textContent = 'ğŸ’° ã‚¢ã‚¤ãƒ†ãƒ å±‹';
            document.getElementById('modal-description').textContent = 'ã„ã‚‰ã£ã—ã‚ƒã„ï¼æ—…ã®åŠ©ã‘ã«ãªã‚‹ã‚‚ã®ãŒã‚ã‚‹ã‚ˆã€‚';
            
            const listDiv = document.getElementById('modal-list');
            listDiv.innerHTML = '';

            Object.keys(ITEMS).forEach(id => {
                const item = ITEMS[id];
                if (id === 'shibori') return; // Don't sell special items
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.innerHTML = `
                    <div class="item-info">
                        <strong>${item.name}</strong> (${item.cost}ä¸¡)<br>
                        <small>${item.description}</small>
                    </div>
                    <button class="btn btn-secondary" onclick="buyItem('${id}')" ${gameState.money < item.cost ? 'disabled' : ''}>è²·ã†</button>
                `;
                listDiv.appendChild(itemDiv);
            });

            const choicesDiv = document.getElementById('modal-choices');
            choicesDiv.innerHTML = `<button class="btn btn-primary" onclick="closeModal()">åº—ã‚’å‡ºã‚‹</button>`;

            document.getElementById('modal').style.display = 'flex';
            gameState.isGameBlocked = true;
            updateControls();
        }
        
        function buyItem(itemId) {
            const item = ITEMS[itemId];
            if (gameState.money >= item.cost) {
                gameState.money -= item.cost;
                gameState.inventory.push(itemId);
                updateGameInfo();
                showShop(); // Refresh shop view
            }
        }

        function showInventory() {
            document.getElementById('modal-title').textContent = 'ğŸ’ æŒã¡ç‰©';
            document.getElementById('modal-description').textContent = 'æŒã£ã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç¢ºèªãƒ»ä½¿ç”¨ã—ã¾ã™ã€‚';
            
            const listDiv = document.getElementById('modal-list');
            listDiv.innerHTML = '';

            if (gameState.inventory.length === 0) {
                listDiv.innerHTML = '<p>æŒã¡ç‰©ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            } else {
                gameState.inventory.forEach((itemId, index) => {
                    const item = ITEMS[itemId];
                    if (!item) return;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    let useButton = '<button class="btn btn-secondary" onclick="useItem(\'${itemId}\', ${index})">ä½¿ã†</button>';
                    if (itemId === 'shibori' || itemId === 'omamori') {
                        useButton = ''; // Cannot be used directly
                    }

                    itemDiv.innerHTML = `
                        <div class="item-info">
                            <strong>${item.name}</strong><br>
                            <small>${item.description}</small>
                        </div>
                        ${useButton}
                    `;
                    listDiv.appendChild(itemDiv);
                });
            }

            const choicesDiv = document.getElementById('modal-choices');
            choicesDiv.innerHTML = `<button class="btn btn-primary" onclick="closeModal()">é–‰ã˜ã‚‹</button>`;

            document.getElementById('modal').style.display = 'flex';
            gameState.isGameBlocked = true;
            updateControls();
        }
        
        function useItem(itemId, index) {
            const item = ITEMS[itemId];
            
            switch(itemId) {
                case 'dango':
                    gameState.activeEffects['dice_bonus'] = (gameState.activeEffects['dice_bonus'] || 0) + 1;
                    break;
                case 'waraji':
                    gameState.activeEffects['cost_reduction'] = (gameState.activeEffects['cost_reduction'] || 0) + 3;
                    break;
                case 'map':
                     const move = prompt("1ï½3ã®å¥½ããªæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "1");
                     const steps = parseInt(move, 10);
                     if (!isNaN(steps) && steps >= 1 && steps <= 3) {
                         closeModal();
                         setTimeout(() => movePlayer(steps), 300);
                     } else {
                         alert("ç„¡åŠ¹ãªå…¥åŠ›ã§ã™");
                         return;
                     }
                    break;
            }
            
            gameState.inventory.splice(index, 1);
            showInventory();
        }

        function updateGameInfo() {
            const currentStation = TOKAIDO_STATIONS[gameState.currentPosition];
            document.getElementById('current-station').textContent = currentStation.name;
            document.getElementById('station-count').textContent = gameState.currentPosition + 1;
            document.getElementById('money').textContent = `${gameState.money}ä¸¡`;
            document.getElementById('days').textContent = `${gameState.days}æ—¥`;
            
            const progress = (gameState.currentPosition / (TOKAIDO_STATIONS.length - 1)) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
        }
        
        function updateControls() {
            const rollBtn = document.getElementById('roll-btn');
            const shopBtn = document.getElementById('shop-btn');
            
            rollBtn.disabled = gameState.isGameBlocked;
            rollBtn.textContent = gameState.isGameBlocked ? 'ã‚¤ãƒ™ãƒ³ãƒˆä¸­...' : 'ğŸ² ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹';

            const station = TOKAIDO_STATIONS[gameState.currentPosition];
            shopBtn.style.display = station.market && !gameState.isGameBlocked ? 'inline-block' : 'none';
        }

        function showStationInfo() {
            if(gameState.isGameBlocked) return;
            const currentStation = TOKAIDO_STATIONS[gameState.currentPosition];
            let info = `ğŸ“ ç¾åœ¨åœ°: ${currentStation.name}

`;
            info += `ğŸ“ èª¬æ˜: ${currentStation.description}

`;
            let type = [];
            if(currentStation.market) type.push('ã‚¢ã‚¤ãƒ†ãƒ å±‹ã‚ã‚Š');
            if(currentStation.event) type.push('ã‚¤ãƒ™ãƒ³ãƒˆã‚ã‚Š');
            if(type.length === 0) type.push('æ™®é€šã®å®¿å ´');
            info += `ğŸ¨ å®¿å ´ã‚¿ã‚¤ãƒ—: ${type.join(', ')}

`;
            info += `ğŸ“Š é€²è¡Œåº¦: ${gameState.currentPosition + 1}/${TOKAIDO_STATIONS.length} (${Math.round((gameState.currentPosition / (TOKAIDO_STATIONS.length - 1)) * 100)}%)`;
            alert(info);
        }

        function showVictory() {
            let message = 'ğŸ‰ æ±æµ·é“äº”åä¸‰æ¬¡åˆ¶è¦‡ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸ‰

';
            message += `ğŸ“… æ—…è¡ŒæœŸé–“: ${gameState.days}æ—¥
`;
            message += `ğŸ’° æ®‹ã‚Šæ‰€æŒé‡‘: ${gameState.money}ä¸¡
`;
            
            let score = gameState.money - (gameState.days * 10);
            if (gameState.inventory.includes('shibori')) {
                message += "æ—…ã®è¨˜å¿µã«è²·ã£ãŸæœ‰æ¾çµã‚Šã¯ã€ç´ æ™´ã‚‰ã—ã„æ€ã„å‡ºã¨ãªã£ãŸã€‚
";
                score += 300; // Bonus for the special item
            }

            let rank = '';
            if (score >= 1000) {
                rank = 'ğŸ† æ—…ã®é”äºº';
            } else if (score >= 500) {
                rank = 'ğŸ¥‰ ç†Ÿç·´æ—…äºº';
            } else if (score >= 100) {
                rank = 'ğŸ¥ˆ æ™®é€šã®æ—…äºº';
            } else {
                rank = 'ğŸ¥‡ ã®ã‚“ã³ã‚Šæ—…äºº';
            }
            
            message += `
ç·åˆè©•ä¾¡: ${rank}`;
            showModal("æ—…ã®çµ‚ã‚ã‚Š", message);
        }

        function resetGame() {
            if (confirm('æ–°ã—ã„æ—…ã‚’å§‹ã‚ã¾ã™ã‹ï¼Ÿ')) {
                initGame();
            }
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        initGame();
    </script>
</body>
</html>