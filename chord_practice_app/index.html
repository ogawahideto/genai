<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コード進行練習アプリ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        #playBtn {
            background-color: #4CAF50;
            color: white;
        }
        
        #playBtn:hover {
            background-color: #45a049;
        }
        
        #playBtn.playing {
            background-color: #f44336;
        }
        
        #playBtn.playing:hover {
            background-color: #da190b;
        }
        
        input[type="range"] {
            width: 150px;
        }
        
        .current-chord {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #333;
            margin: 30px 0;
            min-height: 60px;
        }
        
        .chord-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .guitar-chord, .piano-chord {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .guitar-chord h3, .piano-chord h3 {
            margin-top: 0;
            color: #555;
        }
        
        .guitar-frets {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            margin: 20px 0;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .fret {
            width: 40px;
            height: 25px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background-color: white;
        }
        
        .fret.pressed {
            background-color: #4CAF50;
            color: white;
            border-radius: 50%;
        }
        
        .fret.open {
            background-color: #e8f5e8;
            font-weight: bold;
        }
        
        .fret.muted {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .piano-keys {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
            height: 120px;
        }
        
        .white-key {
            width: 30px;
            height: 120px;
            background-color: white;
            border: 1px solid #ccc;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            font-size: 12px;
        }
        
        .white-key.active {
            background-color: #4CAF50;
            color: white;
        }
        
        .black-key {
            width: 20px;
            height: 80px;
            background-color: #333;
            position: absolute;
            z-index: 2;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 5px;
            font-size: 10px;
            color: white;
        }
        
        .black-key.active {
            background-color: #4CAF50;
        }
        
        .progression-display {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            color: #666;
        }
        
        .beat-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .beat {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #ddd;
            transition: background-color 0.1s;
        }
        
        .beat.active {
            background-color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>コード進行練習アプリ</h1>
        
        <div class="controls">
            <button id="playBtn">再生</button>
            
            <div class="control-group">
                <label for="bpm">BPM:</label>
                <input type="range" id="bpm" min="60" max="180" value="120">
                <span id="bpmValue">120</span>
            </div>
            
            <div class="control-group">
                <label for="progression">進行:</label>
                <select id="progression">
                    <option value="basic">基本 (C-Am-F-G)</option>
                    <option value="blues">ブルース (C-C7-F-C-G7-C)</option>
                    <option value="jazz">ジャズ (Dm7-G7-CM7-A7)</option>
                    <option value="pop">ポップス (C-G-Am-F)</option>
                </select>
            </div>
        </div>
        
        <div class="progression-display" id="progressionDisplay"></div>
        
        <div class="beat-indicator" id="beatIndicator">
            <div class="beat"></div>
            <div class="beat"></div>
            <div class="beat"></div>
            <div class="beat"></div>
        </div>
        
        <div class="current-chord" id="currentChord">C</div>
        
        <div class="chord-info">
            <div class="guitar-chord">
                <h3>ギターコード</h3>
                <div class="guitar-frets" id="guitarChord"></div>
                <div id="guitarFingers"></div>
            </div>
            
            <div class="piano-chord">
                <h3>ピアノコード</h3>
                <div class="piano-keys" id="pianoKeys"></div>
            </div>
        </div>
    </div>
    
    <script>
        // コード定義
        const chords = {
            'C': {
                guitar: { frets: [0, 1, 0, 2, 1, 0], fingers: ['開放', '1fret-人差し指', '開放', '2fret-中指', '1fret-人差し指', '開放'] },
                piano: ['C', 'E', 'G']
            },
            'Am': {
                guitar: { frets: [0, 0, 2, 2, 1, 0], fingers: ['開放', '開放', '2fret-中指', '2fret-薬指', '1fret-人差し指', '開放'] },
                piano: ['A', 'C', 'E']
            },
            'F': {
                guitar: { frets: [1, 1, 3, 3, 2, 1], fingers: ['1fret-人差し指', '1fret-人差し指', '3fret-薬指', '3fret-小指', '2fret-中指', '1fret-人差し指'] },
                piano: ['F', 'A', 'C']
            },
            'G': {
                guitar: { frets: [3, 2, 0, 0, 3, 3], fingers: ['3fret-小指', '2fret-中指', '開放', '開放', '3fret-薬指', '3fret-小指'] },
                piano: ['G', 'B', 'D']
            },
            'C7': {
                guitar: { frets: [0, 1, 3, 2, 1, 0], fingers: ['開放', '1fret-人差し指', '3fret-薬指', '2fret-中指', '1fret-人差し指', '開放'] },
                piano: ['C', 'E', 'G', 'Bb']
            },
            'G7': {
                guitar: { frets: [3, 2, 0, 0, 0, 1], fingers: ['3fret-薬指', '2fret-中指', '開放', '開放', '開放', '1fret-人差し指'] },
                piano: ['G', 'B', 'D', 'F']
            },
            'Dm7': {
                guitar: { frets: [-1, -1, 0, 2, 1, 1], fingers: ['ミュート', 'ミュート', '開放', '2fret-中指', '1fret-人差し指', '1fret-人差し指'] },
                piano: ['D', 'F', 'A', 'C']
            },
            'CM7': {
                guitar: { frets: [0, 3, 2, 0, 0, 0], fingers: ['開放', '3fret-薬指', '2fret-中指', '開放', '開放', '開放'] },
                piano: ['C', 'E', 'G', 'B']
            },
            'A7': {
                guitar: { frets: [0, 0, 2, 0, 2, 0], fingers: ['開放', '開放', '2fret-中指', '開放', '2fret-薬指', '開放'] },
                piano: ['A', 'C#', 'E', 'G']
            }
        };
        
        // コード進行定義
        const progressions = {
            'basic': ['C', 'Am', 'F', 'G'],
            'blues': ['C', 'C7', 'F', 'C', 'G7', 'C'],
            'jazz': ['Dm7', 'G7', 'CM7', 'A7'],
            'pop': ['C', 'G', 'Am', 'F']
        };
        
        // アプリの状態
        let isPlaying = false;
        let currentChordIndex = 0;
        let currentProgression = 'basic';
        let bpm = 120;
        let beatCount = 0;
        let intervalId = null;
        
        // 音声コンテキスト
        let audioContext = null;
        
        // DOM要素の取得
        const playBtn = document.getElementById('playBtn');
        const bpmSlider = document.getElementById('bpm');
        const bpmValue = document.getElementById('bpmValue');
        const progressionSelect = document.getElementById('progression');
        const currentChordElement = document.getElementById('currentChord');
        const guitarChordElement = document.getElementById('guitarChord');
        const guitarFingersElement = document.getElementById('guitarFingers');
        const pianoKeysElement = document.getElementById('pianoKeys');
        const progressionDisplayElement = document.getElementById('progressionDisplay');
        const beatIndicatorElement = document.getElementById('beatIndicator');
        
        // 初期化
        function init() {
            updateProgressionDisplay();
            updateChordDisplay();
            setupPianoKeys();
        }
        
        // 進行表示の更新
        function updateProgressionDisplay() {
            const progression = progressions[currentProgression];
            progressionDisplayElement.textContent = `進行: ${progression.join(' - ')}`;
        }
        
        // コード表示の更新
        function updateChordDisplay() {
            const progression = progressions[currentProgression];
            const chord = progression[currentChordIndex];
            currentChordElement.textContent = chord;
            
            updateGuitarChord(chord);
            updatePianoChord(chord);
        }
        
        // ギターコードの表示更新
        function updateGuitarChord(chordName) {
            const chord = chords[chordName];
            guitarChordElement.innerHTML = '';
            guitarFingersElement.innerHTML = '';
            
            if (chord && chord.guitar) {
                // フレット表示
                chord.guitar.frets.forEach((fret, index) => {
                    const fretElement = document.createElement('div');
                    fretElement.className = 'fret';
                    
                    if (fret === -1) {
                        fretElement.textContent = '×';
                        fretElement.classList.add('muted');
                    } else if (fret === 0) {
                        fretElement.textContent = '○';
                        fretElement.classList.add('open');
                    } else {
                        fretElement.textContent = fret;
                        fretElement.classList.add('pressed');
                    }
                    
                    guitarChordElement.appendChild(fretElement);
                });
                
                // 指使い表示
                guitarFingersElement.innerHTML = `<small>${chord.guitar.fingers.join(' | ')}</small>`;
            }
        }
        
        // ピアノ鍵盤のセットアップ
        function setupPianoKeys() {
            const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackKeys = ['C#', 'D#', null, 'F#', 'G#', 'A#', null];
            
            pianoKeysElement.innerHTML = '';
            
            // 白鍵
            whiteKeys.forEach((key, index) => {
                const keyElement = document.createElement('div');
                keyElement.className = 'white-key';
                keyElement.textContent = key;
                keyElement.style.left = `${index * 30}px`;
                pianoKeysElement.appendChild(keyElement);
            });
            
            // 黒鍵
            blackKeys.forEach((key, index) => {
                if (key) {
                    const keyElement = document.createElement('div');
                    keyElement.className = 'black-key';
                    keyElement.textContent = key;
                    keyElement.style.left = `${index * 30 + 20}px`;
                    pianoKeysElement.appendChild(keyElement);
                }
            });
        }
        
        // ピアノコードの表示更新
        function updatePianoChord(chordName) {
            const chord = chords[chordName];
            
            // 全ての鍵盤をリセット
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                key.classList.remove('active');
            });
            
            if (chord && chord.piano) {
                chord.piano.forEach(note => {
                    const keyElement = document.querySelector(`.white-key:contains('${note}'), .black-key:contains('${note}')`);
                    if (keyElement) {
                        keyElement.classList.add('active');
                    } else {
                        // テキスト内容で検索
                        const keys = document.querySelectorAll('.white-key, .black-key');
                        keys.forEach(key => {
                            if (key.textContent === note) {
                                key.classList.add('active');
                            }
                        });
                    }
                });
            }
        }
        
        // メトロノーム音の生成
        function playMetronomeSound(isDownbeat = false) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(isDownbeat ? 880 : 440, audioContext.currentTime);
            oscillator.type = 'square';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }
        
        // ビート表示の更新
        function updateBeatIndicator() {
            const beats = document.querySelectorAll('.beat');
            beats.forEach((beat, index) => {
                beat.classList.toggle('active', index === beatCount);
            });
        }
        
        // 再生/停止の切り替え
        function togglePlayback() {
            if (isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }
        
        // 再生開始
        function startPlayback() {
            isPlaying = true;
            playBtn.textContent = '停止';
            playBtn.classList.add('playing');
            
            const beatsPerMinute = bpm;
            const millisecondsPerBeat = 60000 / beatsPerMinute;
            
            intervalId = setInterval(() => {
                updateBeatIndicator();
                playMetronomeSound(beatCount === 0);
                
                if (beatCount === 0) {
                    updateChordDisplay();
                }
                
                beatCount = (beatCount + 1) % 4;
                
                if (beatCount === 0) {
                    const progression = progressions[currentProgression];
                    currentChordIndex = (currentChordIndex + 1) % progression.length;
                }
            }, millisecondsPerBeat);
        }
        
        // 再生停止
        function stopPlayback() {
            isPlaying = false;
            playBtn.textContent = '再生';
            playBtn.classList.remove('playing');
            
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            
            beatCount = 0;
            updateBeatIndicator();
        }
        
        // イベントリスナーの設定
        playBtn.addEventListener('click', togglePlayback);
        
        bpmSlider.addEventListener('input', (e) => {
            bpm = parseInt(e.target.value);
            bpmValue.textContent = bpm;
            
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        });
        
        progressionSelect.addEventListener('change', (e) => {
            currentProgression = e.target.value;
            currentChordIndex = 0;
            updateProgressionDisplay();
            updateChordDisplay();
        });
        
        // 初期化実行
        init();
    </script>
</body>
</html>