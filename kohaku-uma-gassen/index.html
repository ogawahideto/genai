<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬777å› ç´…ç™½é¦¬åˆæˆ¦ 2026 - The Year of the Horse</title>
    <!-- 
    AIãƒ¢ãƒ‡ãƒ«: Gemini 2.0 Flash
    Gemini CLIãƒãƒ¼ã‚¸ãƒ§ãƒ³: 0.1
    ä½œæˆæ—¥æ™‚: 2025-12-30
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: æ—¥æœ¬ã®å¤§ã¿ãã‹ã¨ã„ãˆã°ç´…ç™½æ­Œåˆæˆ¦ã§ã™ãŒã€æ¥å¹´åº¦ã¯åˆå¹´ã§ã‚ã‚‹ã“ã¨ã‚‚ãµã¾ãˆã¦ã€ã“ã“ã§ã¯ç´…ç™½é¦¬åˆæˆ¦ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ãã ã•ã„ã€‚ç´…ç™½æ­Œåˆæˆ¦ã®ãƒ‘ãƒ­ãƒ‡ã‚£ã§ã€ãŠã‚‚ã—ã‚ãŠã‹ã—ã„ç´…ç™½é¦¬åˆæˆ¦ã‚’ä½œã£ã¦ãã ã•ã„ã€‚ã©ã‚“ã©ã‚“ä½œã£ã¡ã‚ƒã£ã¦ã€‚å…¨åŠ›ã§ä½œã£ã¦ã€‚Geminiã®é™ç•Œã¾ã§ä½œã£ã¦ã€‚
    AIã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: 
      - ã‚·ãƒ³ã‚°ãƒ«ãƒšãƒ¼ã‚¸ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ§‹æˆã€‚
      - CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é§†ä½¿ã—ã¦ã€ãƒ©ã‚¤ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¸ã®è‡¨å ´æ„Ÿï¼ˆã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆã€ç´™å¹é›ªã€é¦¬ã®å‹•ãï¼‰ã‚’è¡¨ç¾ã€‚
      - JavaScriptã§ç•ªçµ„é€²è¡Œï¼ˆã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã€å„å¯¾æˆ¦ã€æŠ•ç¥¨ã€é‡é¦¬ã®ä¼šã«ã‚ˆã‚‹é›†è¨ˆã€ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼‰ã‚’åˆ¶å¾¡ã€‚
      - ãƒ¦ãƒ¼ãƒ¢ã‚¢ã®ã‚ã‚‹é¦¬åã€æ›²åã€æ­Œè©ï¼ˆã„ãªãªãç¿»è¨³ï¼‰ã‚’å®Ÿè£…ã€‚
    å®Ÿè£…ã®æ„å›³: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«2026å¹´ã®åˆå¹´ã‚’ç¥ã†ã€é¦¬ã ã‚‰ã‘ã®ç‹‚ä¹±ã¨æ„Ÿå‹•ã®ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆã‚’æä¾›ã™ã‚‹ã€‚
    -->
    <style>
        :root {
            --red-team: #e60033;
            --white-team: #f0f0f0;
            --gold: #ffd700;
            --stage-bg: #1a0b2e;
            --text-color: #fff;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--stage-bg);
            color: var(--text-color);
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            overflow: hidden;
            user-select: none;
        }

        #app {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* --- Stage Effects --- */
        .spotlight {
            position: absolute;
            top: -50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0) 60%);
            transform: translateX(-50%) rotate(0deg);
            pointer-events: none;
            z-index: 0;
            animation: spotlight-move 10s infinite alternate ease-in-out;
        }

        @keyframes spotlight-move {
            0% { transform: translateX(-50%) rotate(-10deg); }
            100% { transform: translateX(-50%) rotate(10deg); }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--gold);
            animation: fall linear forwards;
            z-index: 5;
        }

        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }

        /* --- Main Stage Area --- */
        #stage {
            width: 90%;
            max-width: 800px;
            height: 60%;
            background: linear-gradient(to bottom, #333, #000);
            border: 5px solid var(--gold);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
            z-index: 1;
        }

        .curtain {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background: repeating-linear-gradient(90deg, #b00, #900 20px, #b00 40px);
            transition: transform 2s ease-in-out;
            z-index: 10;
        }
        .curtain.left { left: 0; transform-origin: left top; }
        .curtain.right { right: 0; transform-origin: right top; }
        .curtain-open .curtain.left { transform: scaleX(0); }
        .curtain-open .curtain.right { transform: scaleX(0); }

        /* --- Performers --- */
        .performer {
            font-size: 100px;
            position: absolute;
            bottom: 20px;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
            transform-origin: bottom center;
        }

        .performer.red { filter: drop-shadow(0 0 20px var(--red-team)); }
        .performer.white { filter: drop-shadow(0 0 20px var(--white-team)); }
        
        /* Animations for horses */
        .dance-jump { animation: jump 0.5s infinite alternate; }
        .dance-shake { animation: shake 0.2s infinite; }
        .dance-spin { animation: spin 1s infinite linear; }
        .dance-slide { animation: slide 2s infinite alternate ease-in-out; }

        @keyframes jump { 0% { transform: translateY(0); } 100% { transform: translateY(-50px) scale(1.1); } }
        @keyframes shake { 0% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }
        @keyframes spin { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
        @keyframes slide { 0% { left: 10%; } 100% { left: 70%; } }

        /* --- UI Elements --- */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        #header {
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 10px;
            border-bottom: 3px solid var(--gold);
        }

        h1 {
            margin: 0;
            font-size: 2rem;
            text-shadow: 2px 2px 0 var(--red-team), -2px -2px 0 var(--white-team);
            letter-spacing: 2px;
        }

        #subtitle {
            font-size: 0.9rem;
            color: #ccc;
        }

        #lyrics-container {
            text-align: center;
            margin-bottom: 20px;
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .lyric-line {
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px #000;
            opacity: 0;
            transition: opacity 0.3s;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
        }
        .lyric-line.active { opacity: 1; }
        .lyric-sub { font-size: 0.9rem; color: var(--gold); margin-top: 5px; }

        #controls {
            pointer-events: auto;
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s, box-shadow 0.1s;
            color: #333;
        }
        .btn:active { transform: scale(0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-red { background: linear-gradient(45deg, var(--red-team), #ff6b6b); color: white; }
        .btn-white { background: linear-gradient(45deg, var(--white-team), #e0e0e0); color: #333; }
        .btn-gold { background: linear-gradient(45deg, var(--gold), #f7e28b); color: #5a4a00; border: 2px solid #fff; }

        /* --- Score Board --- */
        #scoreboard {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #555;
            text-align: right;
            pointer-events: auto; /* For wild bird society counting */
        }
        .score-row { font-size: 1.2rem; margin: 5px 0; display: flex; align-items: center; gap: 10px; }
        .score-bar { height: 10px; width: 0; transition: width 0.5s; }
        .red-bar { background-color: var(--red-team); }
        .white-bar { background-color: var(--white-team); }

        /* --- Overlay (Dialogs) --- */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        #overlay.hidden { display: none; }
        
        .dialog-box {
            background: #fff;
            color: #333;
            padding: 30px;
            border-radius: 20px;
            max-width: 80%;
            border: 5px solid var(--gold);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .host-icon { font-size: 60px; display: block; margin-bottom: 10px; }
        .dialog-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: var(--red-team); }
        .dialog-text { font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px; }

        /* --- Wild Horse Society Counter --- */
        #counter-mode {
            position: absolute;
            top:0; left:0; width:100%; height:100%;
            background: rgba(0,50,0,0.9);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .binocular-view {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .lens {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid #000;
            background: #fff;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .lens::after {
            content: '';
            position: absolute;
            width: 100%; height: 2px; background: rgba(0,0,0,0.2); top: 50%;
        }
        .lens::before {
            content: '';
            position: absolute;
            height: 100%; width: 2px; background: rgba(0,0,0,0.2); left: 50%;
        }
        .count-num { font-size: 3rem; font-family: 'Courier New', monospace; font-weight: bold; }
        .red-count { color: var(--red-team); }
        .white-count { color: #333; } /* Inside white lens */

        /* Responsive */
        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            .performer { font-size: 60px; }
            .btn { padding: 10px 20px; font-size: 1rem; }
            #stage { height: 50%; }
        }
    </style>
</head>
<body>

<div id="app">
    <div class="spotlight"></div>
    
    <!-- Stage -->
    <div id="stage" class="">
        <div class="curtain left"></div>
        <div class="curtain right"></div>
        <!-- Performers will be injected here -->
        <div id="performer-area"></div>
    </div>

    <!-- UI Overlay -->
    <div id="ui-layer">
        <div id="header">
            <h1>ğŸ”´ ç´…ç™½é¦¬åˆæˆ¦ 2026 âšª</h1>
            <div id="subtitle">ã€œ ãƒ’ãƒ’ãƒ¼ãƒ³ã¨éŸ¿ã‘ï¼åˆå¹´ã®æ­Œå£° ã€œ</div>
        </div>

        <div id="scoreboard">
            <div class="score-row">
                ğŸ”´ <div id="bar-red" class="score-bar red-bar"></div> <span id="score-red">0</span>
            </div>
            <div class="score-row">
                âšª <div id="bar-white" class="score-bar white-bar"></div> <span id="score-white">0</span>
            </div>
        </div>

        <div><!-- Spacer --></div>

        <div id="lyrics-container">
            <div id="lyric-main" class="lyric-line"></div>
            <div id="lyric-sub" class="lyric-sub"></div>
        </div>

        <div id="controls">
            <!-- Dynamic buttons -->
        </div>
    </div>

    <!-- Dialog Overlay -->
    <div id="overlay">
        <div class="dialog-box">
            <span class="host-icon">ğŸ•¶ï¸ğŸ´</span>
            <div class="dialog-title" id="dialog-title">Welcome</div>
            <div class="dialog-text" id="dialog-text">æº–å‚™ã¯ã„ã„ã‹ãªï¼Ÿ</div>
            <button class="btn btn-gold" id="dialog-btn">æ¬¡ã¸</button>
        </div>
    </div>

    <!-- Wild Bird Society Counter Mode -->
    <div id="counter-mode">
        <h2 style="color:#fff; text-shadow:0 0 10px #0f0;">æ—¥æœ¬é‡é¦¬ã®ä¼š é›†è¨ˆä¸­...</h2>
        <div class="binocular-view">
            <div class="lens">
                <div class="count-num red-count" id="final-red">0</div>
            </div>
            <div class="lens">
                <div class="count-num white-count" id="final-white">0</div>
            </div>
        </div>
        <div style="color:#aaa;">(â€»ä¼šå ´ã®ãƒ‹ãƒ³ã‚¸ãƒ³ã‚’é›†è¨ˆã—ã¦ã„ã¾ã™)</div>
    </div>
</div>

<script>
    // --- Data & State ---
    const state = {
        scores: { red: 0, white: 0 },
        currentPhase: 0, // 0:Intro, 1:Battle1, 2:Battle2, 3:Finale, 4:Voting, 5:Result
        isPerforming: false
    };

    const program = [
        {
            type: 'battle',
            title: 'ç¬¬1å›æˆ¦ï¼šã‚¢ã‚¤ãƒ‰ãƒ«å¯¾æ±º',
            red: {
                name: 'ã‚­ãƒ£ãƒªãƒ¼ãƒ»ãƒãƒ‹ãƒ¼ãƒãƒ‹ãƒ¼',
                song: 'ãƒ‹ãƒ³ã‚¸ãƒ³ãƒ»ãƒã‚¤ãƒã‚¤',
                icon: 'ğŸ¦„',
                color: 'red',
                lyrics: [
                    { original: 'ãƒ’ãƒ’ãƒ¼ãƒ³ï¼ ãƒ–ãƒ«ãƒ«ãƒƒï¼', sub: 'ãƒ‹ãƒ³ã‚¸ãƒ³ãƒ»ãƒã‚¤ãƒã‚¤ãƒ»ãƒã‚¤ï¼' },
                    { original: 'ãƒ‘ã‚«ãƒƒ ãƒ‘ã‚«ãƒƒ ãƒ‘ã‚«ãƒƒï¼', sub: 'ã‚ã®ç‰§å ´ã¸è¡Œã“ã†ï¼' },
                    { original: 'ãƒ–ãƒ’ãƒ’ãƒ¼ãƒ³ï¼ (Key Change)', sub: 'ã‚«ãƒ¯ã‚¤ã‚¤é¦¬ã«ã¯æ—…ã‚’ã•ã›ã‚ˆï¼' }
                ],
                animation: 'dance-jump'
            },
            white: {
                name: 'ãƒ›ãƒ¯ã‚¤ãƒˆãƒ»ã‚¹ãƒˆãƒªã‚ªãƒ³',
                song: 'èµ°ã‚Œãƒ¡ãƒ­ã‚¹ã®ã‚ˆã†ã«',
                icon: 'ğŸ ',
                color: 'white',
                lyrics: [
                    { original: 'ãƒ–ãƒ«ãƒ«... ãƒ’ãƒ’ãƒ¼ãƒ³ï¼', sub: 'é¢¨ã‚’åˆ‡ã£ã¦èµ°ã‚Œï¼' },
                    { original: 'ãƒ‘ã‚«ãƒ‘ã‚«ãƒƒï¼ ãƒ‘ã‚«ãƒ‘ã‚«ãƒƒï¼', sub: 'å‹æƒ…ã®ãŸã‚ã«ï¼' },
                    { original: 'ãƒ’ãƒ’ãƒ’ãƒ’ãƒ¼ãƒ³ï¼', sub: 'ç´„æŸã®åœ°ã¸ï¼' }
                ],
                animation: 'dance-slide'
            }
        },
        {
            type: 'battle',
            title: 'ç¬¬2å›æˆ¦ï¼šæ¼”æ­Œã®å¿ƒ',
            red: {
                name: 'çŸ³é¦¬ ã‚µãƒ¦ãƒª',
                song: 'æ´¥è»½æµ·å³¡ãƒ»å†¬æ”¾ç‰§',
                icon: 'ğŸ¦“', // Zebra as a veteran? Or just a unique horse
                color: 'red',
                lyrics: [
                    { original: 'ãƒ’... ãƒ’ãƒ’ãƒ¼ãƒ³...', sub: 'ä¸Šé‡ç™ºã®å¤œè¡Œåˆ—è»Šé™ã‚ŠãŸæ™‚ã‹ã‚‰...' },
                    { original: 'ãƒ–ãƒ«ãƒ«ãƒ«ãƒ«ã‚¥...', sub: 'ç‰§å ´ã¯é›ªã®ä¸­...' },
                    { original: 'ãƒ’ãƒ’ãƒ¼ãƒ³ï¼ãƒ’ãƒ’ãƒ¼ãƒ³ï¼', sub: 'é¦¬ä¸€é ­ã€å‡ãˆãã†ã§ã™...' }
                ],
                animation: 'dance-shake'
            },
            white: {
                name: 'åŒ—ç‰§ ã‚µãƒ–ãƒ­ãƒ¼',
                song: 'ç‰§å ´ã®ç¥­ã‚Š',
                icon: 'ğŸ',
                color: 'white',
                lyrics: [
                    { original: 'ãƒ–ãƒ•ã‚©ã‚©ã‚©ï¼', sub: 'ã¾ãƒ¼ã¤ã‚Šã ï¼ã¾ã¤ã‚Šã ï¼' },
                    { original: 'ãƒ’ãƒ’ãƒ¼ãƒ³ï¼ ãƒ‘ã‚«ãƒƒï¼', sub: 'ã‚­ã‚¿ã‚µãƒ³ã‚‚èµ°ã‚‹ï¼' },
                    { original: 'ãƒ–ãƒ«ãƒ«ãƒƒï¼ ãƒ’ãƒ’ãƒ¼ãƒ³ï¼', sub: 'ã“ã‚ŒãŒæ—¥æœ¬ã®é¦¬ç¥­ã‚Šï¼' }
                ],
                animation: 'dance-jump'
            }
        },
        {
            type: 'finale',
            title: 'å¤§ãƒˆãƒªï¼šä¼èª¬ã®è¼ã',
            performer: {
                name: 'ãƒãƒ„ãƒ»ã‚±ãƒ³ã‚¿ã‚¦ãƒ­ã‚¹',
                song: 'ã‚±ãƒ³ã‚¿ã‚¦ãƒ­ã‚¹ãƒ»ã‚µãƒ³ãƒ',
                icon: 'âœ¨ğŸ´âœ¨',
                color: 'gold', // Special
                lyrics: [
                    { original: 'ã‚ªãƒ¬ï¼ ã‚ªãƒ¬ï¼', sub: 'å©ã‘ãƒœãƒ³ã‚´ï¼ éŸ¿ã‘è¹„ï¼' },
                    { original: 'ãƒ’ãƒ’ãƒ¼ãƒ³ï¼ ã‚µãƒ³ãƒï¼', sub: 'è¸Šã‚Œå—ã®ã‚«ãƒ¼ãƒ‹ãƒãƒ«ï¼' },
                    { original: 'ã‚±ãƒ³ã‚¿ã‚¦ãƒ­ã‚¹ãƒ»ã‚µãƒ³ãƒï¼ ãƒ’ãƒ’ãƒ¼ãƒ³ï¼', sub: 'ã‚ã æ‹ã›ã‚ˆæš´ã‚Œé¦¬ï¼' }
                ],
                animation: 'dance-spin'
            }
        }
    ];

    // --- DOM Elements ---
    const ui = {
        overlay: document.getElementById('overlay'),
        dialogTitle: document.getElementById('dialog-title'),
        dialogText: document.getElementById('dialog-text'),
        dialogBtn: document.getElementById('dialog-btn'),
        performerArea: document.getElementById('performer-area'),
        controls: document.getElementById('controls'),
        lyricMain: document.getElementById('lyric-main'),
        lyricSub: document.getElementById('lyric-sub'),
        scoreRed: document.getElementById('score-red'),
        scoreWhite: document.getElementById('score-white'),
        barRed: document.getElementById('bar-red'),
        barWhite: document.getElementById('bar-white'),
        stage: document.getElementById('stage'),
        counterMode: document.getElementById('counter-mode'),
        finalRed: document.getElementById('final-red'),
        finalWhite: document.getElementById('final-white'),
        headerTitle: document.querySelector('h1')
    };

    // --- Audio (Simulated) ---
    // In a real app we'd use WebAudio, but here we just visualize.
    
    // --- Advanced Music Engine (Web Audio API) ---
    const MusicEngine = {
        ctx: null,
        isPlaying: false,
        nextNoteTime: 0.0,
        timerID: null,
        tempo: 120,
        lookahead: 100.0, // ms
        scheduleAheadTime: 1.5, // s - Increased significantly to bridge the speech blocking gap
        currentStyle: 'pop',
        beatCount: 0,
        
        // Scale frequencies (Added Octave 1 and Sharps for safety)
        notes: {
            'C1': 32.70, 'D1': 36.71, 'E1': 41.20, 'F1': 43.65, 'G1': 49.00, 'A1': 55.00, 'B1': 61.74,
            'C2': 65.41, 'D2': 73.42, 'E2': 82.41, 'F2': 87.31, 'G2': 98.00, 'A2': 110.00, 'B2': 123.47,
            'C3': 130.81, 'D3': 146.83, 'E3': 164.81, 'F3': 174.61, 'G3': 196.00, 'A3': 220.00, 'B3': 246.94,
            'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'G4': 392.00, 'A4': 440.00, 'B4': 493.88,
            'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 698.46, 'G5': 783.99, 'A5': 880.00,
            // Sharps/Flats needed for Enka/Samba
            'G#2': 103.83, 'F#3': 185.00, 'C#3': 138.59, 'D#3': 155.56
        },

        init: function() {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
            this.setupCompressor();
        },

        setupCompressor: function() {
            // Master Compressor to glue sounds together
            this.compressor = this.ctx.createDynamicsCompressor();
            this.compressor.threshold.setValueAtTime(-24, this.ctx.currentTime);
            this.compressor.knee.setValueAtTime(30, this.ctx.currentTime);
            this.compressor.ratio.setValueAtTime(12, this.ctx.currentTime);
            this.compressor.attack.setValueAtTime(0.003, this.ctx.currentTime);
            this.compressor.release.setValueAtTime(0.25, this.ctx.currentTime);
            this.compressor.connect(this.ctx.destination);
        },

        resume: function() {
            if (this.ctx && this.ctx.state === 'suspended') {
                this.ctx.resume();
            }
        },

        // --- Synthesizer Voices ---

        playTone: function(freq, time, duration, type, vol, attack=0.01, release=0.1) {
            if (!freq || !isFinite(freq)) return; 

            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, time);
            
            gain.gain.setValueAtTime(0, time);
            gain.gain.linearRampToValueAtTime(vol, time + attack);
            gain.gain.exponentialRampToValueAtTime(0.001, time + duration + release);
            
            osc.connect(gain);
            gain.connect(this.compressor);
            
            osc.start(time);
            osc.stop(time + duration + release + 0.1);
            return osc;
        },

        // Vocal Synth (Formant-ish)
        playVocal: function(freq, time, duration) {
            if (!freq || !isFinite(freq)) return;

            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            const filter = this.ctx.createBiquadFilter();

            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(freq, time);

            // Vibrato
            const vibOsc = this.ctx.createOscillator();
            const vibGain = this.ctx.createGain();
            vibOsc.frequency.value = 5; // 5Hz vibrato
            vibGain.gain.value = 3; // Depth
            vibOsc.connect(vibGain);
            vibGain.connect(osc.frequency);
            vibOsc.start(time);
            vibOsc.stop(time + duration + 0.2);

            // Formant Filter (Ah/Oh sound approx)
            filter.type = 'bandpass';
            filter.frequency.setValueAtTime(800, time);
            filter.Q.value = 2.0;

            // Envelope
            gain.gain.setValueAtTime(0, time);
            gain.gain.linearRampToValueAtTime(0.4, time + 0.05); // Slower attack for voice
            gain.gain.linearRampToValueAtTime(0.3, time + duration * 0.8);
            gain.gain.exponentialRampToValueAtTime(0.001, time + duration + 0.2);

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(this.compressor);

            osc.start(time);
            osc.stop(time + duration + 0.2);
        },

        playNoise: function(time, duration, vol) {
            const bufferSize = this.ctx.sampleRate * duration;
            const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            const noise = this.ctx.createBufferSource();
            noise.buffer = buffer;
            const gain = this.ctx.createGain();
            
            const filter = this.ctx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 1000;

            gain.gain.setValueAtTime(vol, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + duration);
            
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(this.compressor);
            noise.start(time);
        },

        // --- Drum Kit ---

        kick: function(time) {
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.frequency.setValueAtTime(150, time);
            osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
            gain.gain.setValueAtTime(0.8, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.5);
            osc.connect(gain);
            gain.connect(this.compressor);
            osc.start(time);
            osc.stop(time + 0.5);
        },

        snare: function(time) {
            this.playNoise(time, 0.2, 0.5);
            this.playTone(200, time, 0.1, 'triangle', 0.2); // body
        },

        hihat: function(time, open) {
            const dur = open ? 0.3 : 0.05;
            this.playNoise(time, dur, 0.2);
        },

        agogo: function(time, high) {
            const freq = high ? 1000 : 700;
            this.playTone(freq, time, 0.1, 'sine', 0.4, 0.001, 0.05);
        },

        whistle: function(time) {
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1500, time);
            osc.frequency.linearRampToValueAtTime(2500, time + 0.1);
            osc.frequency.linearRampToValueAtTime(1500, time + 0.2);
            gain.gain.setValueAtTime(0, time);
            gain.gain.linearRampToValueAtTime(0.3, time + 0.05);
            gain.gain.linearRampToValueAtTime(0, time + 0.3);
            osc.connect(gain);
            gain.connect(this.compressor);
            osc.start(time);
            osc.stop(time + 0.3);
        },

        // --- Scheduler & Sequencer ---

        startMusic: function(style) {
            if (this.isPlaying) return;
            this.resume();
            this.isPlaying = true;
            this.currentStyle = style;
            this.beatCount = 0;
            this.nextNoteTime = this.ctx.currentTime + 0.1;
            
            // Set Tempo
            if (style === 'pop') this.tempo = 128;
            else if (style === 'enka') this.tempo = 70;
            else if (style === 'samba') this.tempo = 145;
            else this.tempo = 120;

            this.scheduler();
        },

        stopMusic: function() {
            this.isPlaying = false;
            clearTimeout(this.timerID);
        },

        scheduler: function() {
            if (!this.isPlaying) return;
            
            // Auto-resume if context suspended unexpectedly
            if (this.ctx.state === 'suspended') this.ctx.resume();

            // Schedule ahead
            while (this.nextNoteTime < this.ctx.currentTime + this.scheduleAheadTime) {
                this.scheduleBeat(this.beatCount, this.nextNoteTime);
                this.nextBeat();
            }
            // Use setTimeout only if not called manually for immediate buffering
            // We clear previous timer to avoid double-scheduling if called manually
            clearTimeout(this.timerID);
            this.timerID = setTimeout(() => this.scheduler(), this.lookahead);
        },

        nextBeat: function() {
            const secondsPerBeat = 60.0 / this.tempo;
            this.nextNoteTime += 0.25 * secondsPerBeat; // 16th note resolution
            this.beatCount++;
        },

        scheduleBeat: function(beatNumber, time) {
            const beat16 = beatNumber % 16;
            const beat4 = Math.floor(beatNumber / 4) % 4; // 0, 1, 2, 3 (Quarter notes)
            const measure = Math.floor(beatNumber / 16);

            // --- POP STYLE ---
            if (this.currentStyle === 'pop') {
                // Progression: C - G - Am - F (Standard Pop)
                const chords = [
                    ['C3','E3','G3'], ['G2','B2','D3'], ['A2','C3','E3'], ['F2','A2','C3']
                ];
                const bassNotes = ['C2', 'G1', 'A1', 'F1'];
                const currentChord = chords[measure % 4];
                const currentBass = bassNotes[measure % 4];

                // Drums
                if (beat16 % 4 === 0) this.kick(time); // 4 on the floor
                if (beat16 % 8 === 4) this.snare(time); // 2 and 4
                if (beat16 % 2 === 0) this.hihat(time, false); // 8th notes

                // Bass (Off-beat bouncy)
                if (beat16 % 4 === 0 || beat16 % 4 === 2) {
                    this.playTone(this.notes[currentBass], time, 0.1, 'sawtooth', 0.4, 0.01, 0.1);
                }
                if (beat16 % 4 === 3) { // Octave jump
                    this.playTone(this.notes[currentBass]*2, time, 0.1, 'sawtooth', 0.3, 0.01, 0.1);
                }

                // Chords (Synth Pad sidechain pump effect simulation by short duration)
                if (beat16 % 4 === 0) {
                    currentChord.forEach((note, i) => {
                         this.playTone(this.notes[note], time, 0.2, 'square', 0.1, 0.05, 0.2);
                    });
                }
                
                // Arpeggio / Melody bits
                if (beat16 % 2 === 0 && Math.random() > 0.3) {
                     const note = currentChord[Math.floor(Math.random()*3)];
                     this.playTone(this.notes[note]*2, time, 0.1, 'sine', 0.1);
                }
            }

            // --- ENKA STYLE ---
            else if (this.currentStyle === 'enka') {
                // Progression: Am - Dm - E7 - Am
                // Scale: A C D E G (Minor Pentatonic-ish)
                const chords = [
                    ['A2','C3','E3'], ['D2','F2','A2'], ['E2','G#2','B2'], ['A2','C3','E3']
                ];
                const bassRoot = ['A1', 'D1', 'E1', 'A1'];
                const i = measure % 4;

                // Drums (Slow & Heavy)
                if (beat16 === 0) this.kick(time);
                if (beat16 === 12) this.snare(time); // Backbeat (slow)
                
                // Bass (Roots)
                if (beat16 === 0) this.playTone(this.notes[bassRoot[i]], time, 0.4, 'triangle', 0.5, 0.05, 0.5);
                if (beat16 === 8) this.playTone(this.notes[bassRoot[i]] * 1.5, time, 0.3, 'triangle', 0.4, 0.05, 0.5); // 5th

                // Chords (Tremolo Mandolin/Guitar style)
                if (beat16 % 2 === 0) {
                    chords[i].forEach(note => {
                        this.playTone(this.notes[note], time, 0.08, 'sawtooth', 0.1, 0.01, 0.05);
                    });
                }

                // Lead Melody (Pentatonic improv)
                if (beat16 % 4 === 0 && Math.random() > 0.4) {
                    const scale = ['A4', 'B4', 'C5', 'E5', 'F5', 'A5']; // Miyako-bushi vibe
                    const note = scale[Math.floor(Math.random()*scale.length)];
                    // Add vibrato logic? (Simulated by playing slightly detuned or just long release)
                    this.playTone(this.notes[note], time, 0.3, 'square', 0.2, 0.1, 0.3);
                }
            }

            // --- SAMBA STYLE ---
            else if (this.currentStyle === 'samba') {
                // Progression: G - D7 (Typical 2 chord jam)
                const bassNotes = ['G2', 'D2'];
                const i = Math.floor(measure/2) % 2;

                // Percussion Carnival
                // Kick: Surdo pattern (dotted rhythm)
                if (beat16 === 0 || beat16 === 6 || beat16 === 12) this.kick(time);
                
                // Hihats / Shakers (16th notes)
                this.playNoise(time, 0.05, beat16 % 4 === 0 ? 0.2 : 0.1);
                
                // Agogo
                if (beat16 === 4) this.agogo(time, false); // Low
                if (beat16 === 10) this.agogo(time, true);  // High
                if (beat16 === 14) this.agogo(time, true);

                // Whistle
                if (measure % 4 === 3 && beat16 === 0) this.whistle(time);
                if (measure % 4 === 3 && beat16 === 2) this.whistle(time);

                // Bass
                if (beat16 % 4 === 0) {
                     this.playTone(this.notes[bassNotes[i]], time, 0.15, 'triangle', 0.6);
                }

                // Piano Montuno-ish chords
                if (beat16 % 4 === 2) {
                    const chord = i===0 ? ['G3','B3','D4'] : ['F#3','C4','D4'];
                    chord.forEach(n => this.playTone(this.notes[n], time, 0.1, 'sawtooth', 0.2));
                }
            }
        },

        // --- Speech ---
        speak: function(text, type, pitchFactor = 1.0) {
            if (!window.speechSynthesis) return;
            
            // 1. Force Scheduler to run NOW and fill the buffer ahead of the speech block
            if (this.isPlaying) {
                this.scheduler(); 
            }

            // 2. Wrap speech in timeout to let the scheduler's pushed events register
            setTimeout(() => {
                window.speechSynthesis.cancel();

                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'ja-JP';
                msg.volume = 1.0;

                // Base Pitch
                let basePitch = 1.0;
                let baseRate = 1.0;

                if (type === 'host') { basePitch = 0.8; baseRate = 1.1; }
                else if (type === 'red') { basePitch = 1.4; baseRate = 1.3; } // Higher base for "singing"
                else if (type === 'white') { basePitch = 0.7; baseRate = 1.0; }
                else if (type === 'gold') { basePitch = 1.0; baseRate = 1.3; }
                else { basePitch = 1.8; baseRate = 1.5; } // Default horse

                // Apply Musical Pitch Factor
                msg.pitch = Math.min(Math.max(basePitch * pitchFactor, 0.1), 2.0); 
                msg.rate = baseRate;

                window.speechSynthesis.speak(msg);
            }, 50); // Small delay to prioritize audio scheduling
        },
        
        // Procedural Singing Helper
        singPhrase: function(text, style) {
            // Split text into rhythmic chunks
            const chunks = text.match(/.{1,3}/g) || [text];
            let delay = 0;
            const now = this.ctx.currentTime;
            
            // Define scale based on style
            let scale = [];
            if (style === 'pop') scale = ['C4', 'E4', 'G4', 'A4'];
            else if (style === 'enka') scale = ['A3', 'B3', 'C4', 'E4', 'F4'];
            else if (style === 'samba') scale = ['G3', 'B3', 'D4', 'E4'];
            else scale = ['C4'];

            chunks.forEach((chunk, i) => {
                const noteName = scale[i % scale.length];
                const freq = this.notes[noteName];
                const duration = 0.5; // Seconds per chunk
                
                // 1. Play Vocal Synth (Melody)
                // Schedule slightly in future to match speech delay
                this.playVocal(freq, now + delay + 0.05, duration);

                // 2. Speak with pitch (0.5 to 1.5 mapping roughly)
                // Low notes -> lower pitch multiplier
                const pitchFactor = 0.8 + (scale.indexOf(noteName) * 0.2);
                
                setTimeout(() => {
                    this.speak(chunk, style === 'pop' ? 'red' : (style === 'enka' ? 'red' : 'gold'), pitchFactor);
                }, delay * 1000);

                delay += 0.6; // Gap between chunks
            });
            
            return delay; // Total duration
        }
    };

    // --- Game Logic ---

    function init() {
        MusicEngine.init();
        MusicEngine.speak("ã„ã‚ˆã„ã‚ˆå§‹ã¾ã‚Šã¾ã™ã€ç¬¬777å›ã€ç´…ç™½ã€ã‚¦ãƒåˆæˆ¦ï¼", "host");
        
        // Intro Fanfare
        const now = MusicEngine.ctx.currentTime;
        [523, 659, 783, 1046].forEach((f, i) => MusicEngine.playTone(f, now + i*0.1, 0.5, 'triangle', 0.3));
        
        showDialog('å¸ä¼š: ã‚¿ãƒ¢ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¯ã‚¹', 'ã„ã‚ˆã„ã‚ˆå§‹ã¾ã‚Šã¾ã—ãŸã€ç¬¬777å›ç´…ç™½é¦¬åˆæˆ¦ï¼<br>ä»Šå¹´ã¯åˆå¹´ï¼ˆäºˆå®šï¼‰ã¨ã„ã†ã“ã¨ã§ã€é¦¬ãŸã¡ã®ç†±ã„æˆ¦ã„ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚', 'ã‚¹ã‚¿ãƒ¼ãƒˆï¼', () => {
            nextPhase();
        });
    }

    function showDialog(title, text, btnText, callback) {
        ui.dialogTitle.innerText = title;
        ui.dialogText.innerHTML = text;
        ui.dialogBtn.innerText = btnText;
        ui.overlay.classList.remove('hidden');
        
        ui.dialogBtn.onclick = () => {
            MusicEngine.resume(); 
            MusicEngine.playTone(880, MusicEngine.ctx.currentTime, 0.1, 'sine', 0.2); // Click
            ui.overlay.classList.add('hidden');
            if (callback) callback();
        };
    }

    let currentProgramIndex = 0;

    function nextPhase() {
        if (currentProgramIndex >= program.length) {
            startVotingResult();
            return;
        }

        const item = program[currentProgramIndex];
        
        if (item.type === 'battle') {
            playBattle(item);
        } else if (item.type === 'finale') {
            playFinale(item);
        }
    }

    async function playBattle(battleData) {
        ui.stage.classList.remove('curtain-open');
        ui.performerArea.innerHTML = '';
        
        MusicEngine.speak(`æ¬¡ã¯ã€${battleData.red.name} å¯¾ã€${battleData.white.name}ã§ã™ã€‚`, 'host');

        showDialog(battleData.title, 
            `ğŸ”´ ${battleData.red.name} vs âšª ${battleData.white.name}<br>æº–å‚™ã¯ã„ã„ã§ã™ã‹ï¼Ÿ`, 
            'å¯¾æ±ºé–‹å§‹ï¼', 
            async () => {
                ui.stage.classList.add('curtain-open');
                
                // Red turn (POP Style for Red usually, or based on char)
                // Let's vary styles based on program index for demo
                const redStyle = currentProgramIndex === 0 ? 'pop' : 'enka';
                MusicEngine.startMusic(redStyle);
                await playPerformance(battleData.red);
                MusicEngine.stopMusic();

                await new Promise(r => setTimeout(r, 1000)); // Pause

                // White turn
                const whiteStyle = currentProgramIndex === 0 ? 'pop' : 'enka'; // Same genre battle
                MusicEngine.startMusic(whiteStyle);
                await playPerformance(battleData.white);
                MusicEngine.stopMusic();
                
                MusicEngine.speak("æŠ•ç¥¨ã®æ™‚é–“ã§ã™ï¼ãƒ‹ãƒ³ã‚¸ãƒ³ã‚’æŠ•ã’ã¦ãã ã•ã„ï¼", "host");
                showVotingUI(battleData);
            }
        );
    }

    async function playFinale(finaleData) {
        ui.stage.classList.remove('curtain-open');
        ui.performerArea.innerHTML = '';
        
        MusicEngine.speak("ã„ã‚ˆã„ã‚ˆå¤§ãƒˆãƒªã§ã™ã€‚", "host");

        showDialog(finaleData.title,
            `æœ€å¾Œã‚’é£¾ã‚‹ã®ã¯ã“ã®æ–¹ã§ã™ï¼<br>${finaleData.performer.name}ï¼`,
            'ãƒãƒ„ã‚±ãƒ³ãƒ»ã‚µãƒ³ãƒï¼',
            async () => {
                ui.stage.classList.add('curtain-open');
                createConfetti();
                
                MusicEngine.startMusic('samba');
                await playPerformance(finaleData.performer);
                MusicEngine.stopMusic();
                
                currentProgramIndex++;
                nextPhase();
            }
        );
    }

    async function playPerformance(performer) {
        return new Promise(resolve => {
            // Setup stage
            ui.headerTitle.innerText = `â™ª ${performer.song}`;
            ui.performerArea.innerHTML = `<div class="performer ${performer.color} ${performer.animation}">${performer.icon}</div>`;
            
            // Start "BGM" rhythm
            const beatInterval = setInterval(() => {
                // audioSys.playDrum(); // REMOVED - MusicEngine handles this now
            }, 500);

            let lyricIndex = 0;
            
            const nextLine = () => {
                if (lyricIndex >= performer.lyrics.length) {
                    clearInterval(beatInterval);
                    ui.lyricMain.classList.remove('active');
                    ui.lyricMain.innerText = "";
                    ui.lyricSub.innerText = "";
                    setTimeout(resolve, 2000); // Wait for finish
                    return;
                }
                
                const line = performer.lyrics[lyricIndex];
                ui.lyricMain.innerText = line.original;
                ui.lyricSub.innerText = line.sub;
                ui.lyricMain.classList.add('active');
                
                // SINGING!
                // Use current style from engine
                const singingDuration = MusicEngine.singPhrase(line.original, MusicEngine.currentStyle);

                // Shake effect on lyrics update
                ui.stage.style.transform = `scale(${1 + Math.random()*0.02})`;
                setTimeout(()=> ui.stage.style.transform = 'scale(1)', 100);

                lyricIndex++;
                
                // Wait for singing to finish + a bit
                setTimeout(nextLine, (singingDuration * 1000) + 1500); 
            };

            nextLine();
        });
    }

    function showVotingUI(battleData) {
        ui.controls.innerHTML = '';
        
        const btnRed = document.createElement('button');
        btnRed.className = 'btn btn-red';
        btnRed.innerText = `ğŸ”´ ${battleData.red.name} ã«ãƒ‹ãƒ³ã‚¸ãƒ³ï¼`;
        btnRed.onclick = () => vote('red');

        const btnWhite = document.createElement('button');
        btnWhite.className = 'btn btn-white';
        btnWhite.innerText = `âšª ${battleData.white.name} ã«ãƒ‹ãƒ³ã‚¸ãƒ³ï¼`;
        btnWhite.onclick = () => vote('white');

        ui.controls.appendChild(btnRed);
        ui.controls.appendChild(btnWhite);
        
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn btn-gold';
        nextBtn.innerText = 'æ¬¡ã®å¯¾æˆ¦ã¸';
        nextBtn.style.display = 'none';
        nextBtn.onclick = () => {
            MusicEngine.playTone(600, MusicEngine.ctx.currentTime, 0.1, 'square', 0.1);
            currentProgramIndex++;
            ui.controls.innerHTML = '';
            nextPhase();
        };
        ui.controls.appendChild(nextBtn);

        setTimeout(() => {
            nextBtn.style.display = 'block';
        }, 3000);
    }

    function vote(team) {
        state.scores[team] += 100; // Big points
        updateScoreBoard();
        createParticle(team === 'red' ? '#e60033' : '#fff');
        // Musical vote sound
        const freq = team === 'red' ? 440 : 523;
        MusicEngine.playTone(freq, MusicEngine.ctx.currentTime, 0.1, 'sawtooth', 0.2);
    }

    function updateScoreBoard() {
        const total = state.scores.red + state.scores.white + 1; // avoid div by 0
        const rPct = (state.scores.red / total) * 100;
        const wPct = (state.scores.white / total) * 100;
        
        ui.scoreRed.innerText = state.scores.red;
        ui.scoreWhite.innerText = state.scores.white;
        
        ui.barRed.style.width = Math.min(state.scores.red / 10, 100) + 'px';
        ui.barWhite.style.width = Math.min(state.scores.white / 10, 100) + 'px';
    }

    function createParticle(color) {
        const p = document.createElement('div');
        p.style.position = 'absolute';
        p.style.left = (Math.random() * 80 + 10) + '%';
        p.style.bottom = '20%';
        p.style.fontSize = '20px';
        p.innerText = 'ğŸ¥•';
        p.style.transition = 'all 1s ease-out';
        p.style.zIndex = 100;
        ui.stage.appendChild(p);

        setTimeout(() => {
            p.style.transform = `translateY(-200px) rotate(${Math.random()*360}deg)`;
            p.style.opacity = 0;
        }, 50);

        setTimeout(() => p.remove(), 1000);
    }

    function createConfetti() {
        for(let i=0; i<50; i++) {
            const c = document.createElement('div');
            c.className = 'confetti';
            c.style.left = Math.random() * 100 + 'vw';
            c.style.animationDuration = (Math.random() * 3 + 2) + 's';
            c.style.backgroundColor = Math.random() > 0.5 ? 'gold' : 'silver';
            document.body.appendChild(c);
        }
    }

    function startVotingResult() {
        ui.controls.innerHTML = '';
        ui.headerTitle.innerText = "é›†è¨ˆä¸­...";
        ui.counterMode.style.display = 'flex';
        
        MusicEngine.speak("é›†è¨ˆã‚’é–‹å§‹ã—ã¾ã™ã€‚", "host");

        let countR = 0;
        let countW = 0;
        const finalR = state.scores.red;
        const finalW = state.scores.white;

        // "Wild Horse Society" counting effect
        const timer = setInterval(() => {
            const stepR = Math.ceil((finalR - countR) / 10);
            const stepW = Math.ceil((finalW - countW) / 10);
            
            countR += stepR;
            countW += stepW;
            
            ui.finalRed.innerText = countR;
            ui.finalWhite.innerText = countW;
            
            MusicEngine.playTone(800 + (Math.random()*200), MusicEngine.ctx.currentTime, 0.05, 'square', 0.1);

            if (countR >= finalR && countW >= finalW) {
                clearInterval(timer);
                setTimeout(declareWinner, 1500);
            }
        }, 100);
    }

    function declareWinner() {
        ui.counterMode.style.display = 'none';
        const winner = state.scores.red > state.scores.white ? 'ç´…çµ„ï¼ˆç´…é¦¬ï¼‰' : 'ç™½çµ„ï¼ˆç™½é¦¬ï¼‰';
        const color = state.scores.red > state.scores.white ? 'red' : 'white';
        const icon = state.scores.red > state.scores.white ? 'ğŸŒ¹ğŸ´' : 'ğŸ³ï¸ğŸ´';
        
        let msg = "";
        if (state.scores.red === state.scores.white) {
            msg = "ã¾ã•ã‹ã®å¼•ãåˆ†ã‘ï¼ å¹³å’Œãªç‰§å ´ï¼";
        } else {
            msg = `å„ªå‹ã¯... ${winner} ã§ã™ï¼ï¼`;
        }

        ui.stage.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                <div style="font-size:100px;">ğŸŠ${icon}ğŸŠ</div>
                <h1 style="text-shadow: 0 0 20px ${color};">${winner} å„ªå‹ï¼</h1>
            </div>
        `;
        
        createConfetti();
        
        // Fanfare
        const now = MusicEngine.ctx.currentTime;
        [523, 659, 783, 1046, 1318].forEach((f, i) => MusicEngine.playTone(f, now + i*0.1, 0.5, 'square', 0.2));
        MusicEngine.speak(msg + "ã€‚ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼", "host");
        
        showDialog('ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬', 
            `${msg}<br>çš†æ§˜ã€ã‚ˆã„ãŠå¹´ã‚’ï¼ˆåˆå¹´ï¼‰ãŠè¿ãˆãã ã•ã„ï¼`, 
            'è›ã®å…‰ï¼ˆé¦¬Verï¼‰ã‚’è´ã', 
            () => {
                ui.headerTitle.innerText = "â™ª è›ã®å…‰ (Neigh Auld Lang Syne)";
                ui.lyricMain.innerText = "ãƒ’ãƒ’ãƒ¼ãƒ³... (å…‰)";
                ui.lyricSub.innerText = "çª“ã®é›ª...";
                ui.lyricMain.classList.add('active');
                MusicEngine.speak("ãƒ’ãƒ’ãƒ¼ãƒ³... çª“ã®é›ª...", "host");
                
                // Play Auld Lang Syne melody simple
                const now = MusicEngine.ctx.currentTime;
                const m = [523, 659, 587, 523, 392, 523, 523, 659, 783, 880, 783, 659, 523, 392, 440, 523];
                m.forEach((f, i) => MusicEngine.playTone(f, now + i*0.5, 0.4, 'sine', 0.3));
            }
        );
    }

    // Start
    ui.dialogBtn.onclick = () => {
        ui.overlay.classList.add('hidden');
        init();
    };

    // Initial setup override for "Start" button
    ui.dialogTitle.innerText = "ç´…ç™½é¦¬åˆæˆ¦ã¸ã‚ˆã†ã“ã";
    ui.dialogText.innerHTML = "éŸ³ãŒå‡ºã¾ã™ï¼éŸ³é‡ã«ã”æ³¨æ„ãã ã•ã„ã€‚<br>å¸ä¼šã¨é¦¬ãŒå–‹ã‚Šã€æ­Œã„ã¾ã™ã€‚";
    ui.dialogBtn.innerText = "å…¥å ´ã™ã‚‹ (Music ON)";

</script>
</body>
</html>
